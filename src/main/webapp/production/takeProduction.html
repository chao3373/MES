<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>发货单</title>
    <link rel="stylesheet" type="text/css" href="/static/jquery-easyui-1.3.3/themes/bootstrap/easyui.css"></link>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/icon.css"></link>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/static/js/date.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            load();
            loaddg();
        });

        function load() {
            $("#dlg").datagrid({
                url: "/admin/storage/findByState?state=入库",
                columns: [[
                    {
                        field: 'cb',
                        checkbox: "true",
                        align: "center"
                    }, {
                        field: "dingdanhao",
                        width: "150",
                        align: "center",
                        title: "订单编号",
                        formatter:function (val, row) {
                            console.log(row)
                            if(row.ruKu.saleList != null){
                                return row.ruKu.saleList.saleNumber;
                            }
                            else {
                                return "";
                            }
                        }
                    }, {
                        field: "xiangmuhao",
                        width: "150",
                        align: "center",
                        title: "项目号",
                        formatter: function (val,row ) {
                            if(row.ruKu.saleList != null){
                                return row.ruKu.saleList.xiangmuId;
                            }
                            else {
                                return "";
                            }
                        }
                    }, {
                        field: "wuliaohao",
                        width: "150",
                        align: "center",
                        title: "物料编号",
                        formatter: function (val,row ) {
                            if(row.ruKu.bigDrawing != null ){
                                return row.ruKu.bigDrawing.wuliaoId;
                            }
                            else {
                                return "";
                            }
                        }
                    }, {
                        field: "num",
                        width: "150",
                        align: "center",
                        title: "数量",
                        formatter:function (val, row) {
                            if (row.ruKu != null){
                                return row.ruKu.num;
                            }
                            else
                                return "";
                        }
                    }, {
                        field: "ruKuDate",
                        width: "150",
                        align: "center",
                        title: "入库时间",
                        formatter:function (value) {
                            if (value) {
                                var date = new Date(value);
                                var o = {
                                    "M+": date.getMonth() + 1,                 //月份
                                    "d+": date.getDate(),                    //日
                                    "h+": date.getHours(),                   //小时
                                    "m+": date.getMinutes(),                 //分
                                    "s+": date.getSeconds(),                 //秒
                                    "q+": Math.floor((date.getMonth() + 3) / 3), //季度
                                    "S": date.getMilliseconds()             //毫秒
                                };
                                if (/(y+)/.test("yyyy-MM-dd hh:mm:ss"))
                                    var fmt = "yyyy-MM-dd hh:mm:ss".replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
                                for (var k in o)
                                    if (new RegExp("(" + k + ")").test(fmt))
                                        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                                return fmt;
                            } else {
                                return "";
                            }
                        }
                    }]]
            });
        }

        function loaddg() {
            $("#dg").datagrid({
                url: "/admin/storage/findByState?state=准备出库",
                columns: [[
                    {
                        field: 'cb',
                        checkbox: "true",
                        align: "center"
                    }, {
                        field: "dingdanhao",
                        width: "150",
                        align: "center",
                        title: "订单编号",
                        formatter:function (val, row) {
                            console.log(row)
                            if(row.ruKu.saleList != null){
                                return row.ruKu.saleList.saleNumber;
                            }
                            else {
                                return "";
                            }
                        }
                    }, {
                        field: "xiangmuhao",
                        width: "150",
                        align: "center",
                        title: "项目号",
                        formatter: function (val,row ) {
                            if(row.ruKu.saleList != null){
                                return row.ruKu.saleList.xiangmuId;
                            }
                            else {
                                return "";
                            }
                        }
                    }, {
                        field: "wuliaohao",
                        width: "150",
                        align: "center",
                        title: "物料编号",
                        formatter: function (val,row ) {
                            if(row.ruKu.bigDrawing != null ){
                                return row.ruKu.bigDrawing.wuliaoId;
                            }
                            else {
                                return "";
                            }
                        }
                    }, {
                        field: "num",
                        width: "150",
                        align: "center",
                        title: "数量",
                        formatter:function (val, row) {
                            if (row.ruKu != null){
                                return row.ruKu.num;
                            }
                            else
                                return "";
                        }
                    }, {
                        field: "ruKuDate",
                        width: "150",
                        align: "center",
                        title: "入库时间",
                        formatter:function (value) {
                            if (value) {
                                var date = new Date(value);
                                var o = {
                                    "M+": date.getMonth() + 1,                 //月份
                                    "d+": date.getDate(),                    //日
                                    "h+": date.getHours(),                   //小时
                                    "m+": date.getMinutes(),                 //分
                                    "s+": date.getSeconds(),                 //秒
                                    "q+": Math.floor((date.getMonth() + 3) / 3), //季度
                                    "S": date.getMilliseconds()             //毫秒
                                };
                                if (/(y+)/.test("yyyy-MM-dd hh:mm:ss"))
                                    var fmt = "yyyy-MM-dd hh:mm:ss".replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
                                for (var k in o)
                                    if (new RegExp("(" + k + ")").test(fmt))
                                        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                                return fmt;
                            } else {
                                return "";
                            }
                        }
                    }]]
            });
        }

        //准备出库
        function zhunbei() {
            var rows = $("#dlg").datagrid("getSelections");
            var strIds =[];
            for (var i = 0;i < rows.length; i++){
                strIds.push(rows[i].id);
            }
            var ids = strIds.join(",");
            $.ajax({
                url:"/admin/storage/updateState",
                data:{
                    Ids:ids,
                    state:"准备出库"
                },
                async:false,
                success:function (result) {
                    if(result.success){
                        window.location.reload();
                    }
                }
            })

        }

        //出库
        function out() {
            var rows = $("#dg").datagrid("getSelections");
            var strIds =[];
            for (var i = 0;i < rows.length; i++){
                strIds.push(rows[i].id);
            }
            var ids = strIds.join(",");
            $.messager.confirm("系统提示","您确定要将这些产品出库吗",function (r) {
                if(r){
                    $.ajax({
                        url:"/admin/storage/chuku",
                        data:{
                            Ids:ids
                        },
                        async:false,
                        success:function (result) {
                            if(result.success){
                                $("#dg").datagrid("reload");
                                $.messager.alert("系统提示","操作成功");
                            }
                            else {
                                $.messager.alert("系统提示","操作失败");
                            }
                        }
                    })
                }
            })
        }

        //打开任务选择对话框
        function openRoleAddDialog() {
            $("#dlg-main").dialog("open").dialog("setTitle", "添加发货产品");
        }





    </script>
</head>
<body class="easyui-layout">
<div data-options="region:'center'"
     style="padding: 10px; border: 1px">
    <table id="dg" class="easyui-datagrid" rownumbers="true" fit="true" toolbar="#top">
    </table>
</div>

<!-- 顶部工具栏 -->
<div id="top">
    <fieldset style="border-color: #E7F0FF">
        &nbsp;<a href="javascript:openRoleAddDialog()" class="easyui-linkbutton" iconCls="icon-add" plain="true">添加发货商品</a>
        &nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:out()" class="easyui-linkbutton" >发货</a>
    </fieldset>
</div>

<!-- 弹出的框 -->
<div class="easyui-dialog" id="dlg-main"  fit="true" closed="true">
    <table id="dlg" class="easyui-datagrid" fitColumns="false"
           rownumbers="true" toolbar="#tb" fit="true">
    </table>
    <div id="tb" style="padding: 3px;">
        <form id="fm">
            <table>
                <tr>
                    <td>
                        &nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:zhunbei()" class="easyui-linkbutton"
                                                   iconCls="icon-redo" plain="true">准备发货</a>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>

</body>
</html>