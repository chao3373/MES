<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>生产任务</title>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/bootstrap/easyui.css"></link>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/icon.css"></link>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/static/js/date.js"></script>
    <script type="text/javascript">

        $(document).ready(function() {
            loadAddson();
            load();
            $('#dg').datagrid({
                onClickCell: function(index,field){
                    if(field == "tiaoma"){
                        tiaoma(index);
                    }
                }
            });
            $('#addSon').datagrid({
                onClickCell: function(index,field){
                    if(field == "tiaoma"){
                        tiaoma(index);
                    }
                }
            });
        });


        function load(){
            $("#dg").datagrid({
                url:"/admin/shengChan/listProduct",
                columns:[[
                    {
                        field: "id",
                        width: "150",
                        align: "center",
                        title: "id",
                        hidden:"true"
                    },{
                        field: "saleNumber",
                        title:"订单编号",
                        width: "150",
                        align: "center",
                        formatter:function (val, row) {
                            if(row.saleList){
                                return row.saleList.saleNumber;
                            }
                            else {
                                return '';
                            }
                        }
                    },{
                        field: "datu",
                        title:"物料编号",
                        width: "150",
                        align: "center",
                        formatter:function (val, row) {
                            if(row.bigDrawing){
                                return row.bigDrawing.wuliaoId;
                            }
                            else {
                                return '';
                            }
                        }
                    },{
                        field: "xiaotu",
                        title:"图纸编号",
                        width: "150",
                        align: "center",
                        formatter:function (val, row) {
                            if(row.drawing){
                                return row.drawing.wuliaoId;
                            }
                            else {
                                return '';
                            }
                        }
                    },{
                        field: "xiangmuhao",
                        title:"项目号",
                        width: "150",
                        align: "center",
                        formatter:function (val, row) {
                            if(row.saleList){
                                return row.saleList.xiangmuId;
                            }
                            else {
                                return '';
                            }
                        }
                    },{
                        field: 'tiaoma',
                        title: '条码',
                        align: 'center',
                        width: "150",
                        styler:function(){
                            return 'background-color:red;color:white;';
                        },
                        formatter:function (val, row) {
                            return '点击打印';
                        }
                    }
                ]],
                onClickRow:function (index,row) {
                if(row!=null){
                    $("#addSon").datagrid({
                        url: "/admin/shengChan/findBySaleListId",
                        queryParams: {
                            id: row.saleList.id
                        },
                        columns: [[
                            {
                                field: 'id',
                                title: 'id',
                                width: 100,
                                hidden: 'true',
                                align: 'center'
                            }, {
                                field: 'wuliaoId',
                                title: '小图物料编号',
                                width: 100,
                                align: 'center',
                                formatter: function (value, row, index) {
                                    if (!row.drawing) {
                                        return '';
                                    } else {
                                        return row.drawing.wuliaoId;
                                    }
                                }
                            },{
                                field: 'tiaoma',
                                title: '条码',
                                align: 'center',
                                width: "150",
                                styler:function(){
                                    return 'background-color:red;color:white;';
                                },
                                formatter:function (val, row) {
                                    return '点击打印';
                                }
                            }
                        ]]
                    });
                }  }
            });
        }

        //弹出的对话框中的值
        function loadAddson(){
            //下方子图部分的列
            $("#addSon").datagrid({
                columns:[[
                    {
                        field:'id',
                        title:'id',
                        width:100,
                        hidden:'true',
                        align:'center'
                    },{
                        field:'wuliaoId',
                        title:'小图物料编号',
                        width:100,
                        align:'center'
                    },{
                        field: 'tiaoma',
                        title: '条码',
                        align: 'center',
                        width: "150",
                        styler:function(){
                            return 'background-color:red;color:white;';
                        },
                        formatter:function (val, row) {
                            return '点击打印';
                        }
                    }
                ]]
            });

        }

        function tiaoma(index) {
            //$('#dg').datagrid("selectRow", 0);
            var row = $("#dg").datagrid("getRows")[index];
            console.log(row.datuCode)
            $.post("/admin/shengChan/tiaoma",{
                code:row.xiaotuCode
            },function (result) {
                console.log(result);
                if(result.success){
                    print(result.url,row);
                    $("#dg").datagrid("reload");
                }
            },"json");
        }

        //打印
        function print(url,row) {
            var url = "<img style='width:auto;height: 100%;' src='" + url + "'/>";
            // url += result.url;
            // url += "'/>";
            tableString = "";
            tableString += "<div id='tab' style='text-align: center;width: 100%;font-size: 100px; font-weight: 900;'>";
            tableString +="<table style='width: 22%;text-align: center;'>";
            tableString +="<tr><td style='text-align: center;'>" + url;
            tableString += "</td></tr>";
            tableString +="<tr><td>数量："+row.num+"</td></tr>";
            tableString +="<tr><td>交期："+row.referDate.substring(0,10)+"</td></tr>";
            tableString +="</table></div>";
            //tableString += row.saleListProduct.labelNumber;
            if (window.showModalDialog) {
                window.showModalDialog(
                    "..\\print.html",
                    tableString,
                    "location:No;status:No;help:No;dialogWidth:800px;dialogHeight:600px;scroll:auto;");
            } else {
                window.open(
                    "..\\print.html",
                    tableString,
                    "location:No;status:No;help:No;dialogWidth:800px;dialogHeight:600px;scroll:auto;");
            }
        }


        //点击搜索
        function sousuo() {
            console.log($("#xuanze").combobox("getText"))
            $('#dg').datagrid({
                url: '/admin/shengChan/selectRenwu',
                queryParams: {
                    xuanze: $("#xuanze").combobox("getValue"),
                    code: $("#bianma").val()
                }
            });
        }
    </script>
</head>    <!--上面的dg  下面的addSon-->
<body class="easyui-layout" style="margin: 1px">
   <!-- <table id="dg" class="easyui-datagrid"
           fitColumns="false" rownumbers="true" fit="true" singleSelect="false"
           toolbar="#tb1" split="true">
    </table>

    &lt;!&ndash; dg顶部工具栏 &ndash;&gt;
    <div id="tb1">
        <fieldset style="border-color: #E7F0FF">
            <legend></legend>
            <select class="easyui-combobox" id = "xuanze" style="width: 100px" data-options="panelHeight:'auto'" >
                <option value="1">物料编码</option>
                <option value="2">图纸编码</option>
            </select>
            &nbsp;&nbsp;<input  type="text" id="bianma"  name="bianma"  size="15"
                    onkeydown="if(event.keyCode==13) sousuo()" />
            &nbsp;&nbsp;<a href="javascript:sousuo()"
                           class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>
        </fieldset>
    </div>-->
   <div region="north" style="height: 300px">
       <table id="dg" class="easyui-datagrid"
              fitColumns="false" rownumbers="true" singleSelect="true" fit="true"
              toolbar="#tb1" split="true">
       </table>

       <!-- dg顶部工具栏 -->
       <div id="tb1">
           <fieldset style="border-color: #E7F0FF">
               <legend>查询设置</legend>
               &nbsp;订单号&nbsp; <input type="text" id="saleNumber" size="15"/>
               &nbsp;&nbsp;&nbsp;物料编号&nbsp; <input type="text" id="wuliaoId" size="15"/>
               &nbsp;&nbsp;<a href="javascript:searchSale()"
                              class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>
               &nbsp;&nbsp;<a href="javascript:reload()"
                              class="easyui-linkbutton" iconCls="icon-reload" plain="true">刷新</a>
           </fieldset>
       </div>
   </div>

   <div region="center" style="margin-top: 5px">
       <table id="addSon" class="easyui-datagrid" fitColumns="false" singleSelect="true"
              rownumbers="true" fit="true" split="true">
       </table>
   </div>

</body>
</html>