<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>包装入库</title>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/bootstrap/easyui.css"></link>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/icon.css"></link>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/static/js/date.js"></script>
    <script type="text/javascript">
        //显示时间数据时先进行格式化
        function formatDate(val, row) {
            var dateType = "";
            var date = new Date();
            date.setTime(val);
            dateType = date.format("yyyy-MM-dd")
            return dateType;
        }

        $(document).ready(function () {
            loadProcess();
            load();
            $('#dg').datagrid({
                rowStyler: function (index, row) {
                    if (row.remark == "2") {
                        return 'background: #CC2222;color:white'
                    }
                    if (row.remark == "1") {
                        return 'background: #a333c8;color:white'
                    }
                }
            });
        });

        //大图纸
        function load() {
            $("#dg").datagrid({
                url: '/admin/saleList/findByState?state='+"生产完成",
                columns: [[
                    {
                        field: 'cb',
                        checkbox: "true",
                        align: "center"
                    }, {
                        field: "saleNumber",
                        width: "150",
                        align: "center",
                        title: "销售单号"
                    }, {
                        field: "saleDate",
                        width: "150",
                        align: "center",
                        title: "销售日期",
                        formatter: function (value ) {
                            if (value) {
                                var date = new Date(value);
                                var o = {
                                    "M+": date.getMonth() + 1,                 //月份
                                    "d+": date.getDate(),                    //日
                                    "h+": date.getHours(),                   //小时
                                    "m+": date.getMinutes(),                 //分
                                    "s+": date.getSeconds(),                 //秒
                                    "q+": Math.floor((date.getMonth() + 3) / 3), //季度
                                    "S": date.getMilliseconds()             //毫秒
                                };
                                if (/(y+)/.test("yyyy-MM-dd hh:mm:ss"))
                                    var fmt = "yyyy-MM-dd hh:mm:ss".replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
                                for (var k in o)
                                    if (new RegExp("(" + k + ")").test(fmt))
                                        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                                return fmt;
                            } else {
                                return "";
                            }
                        }
                    }, {
                        field: "tuzhiName",
                        width: "150",
                        align: "center",
                        title: "图纸名称"
                    }, {
                        field: "tuzhiId",
                        width: "150",
                        align: "center",
                        title: "图纸编号"
                    }
                ]],
                onClickRow: function (index, row) {

                    $("#addSon").datagrid({
                        url: "/admin/saleList/bigSmallDrawing",
                        queryParams: {
                            id: row.id
                        },
                        columns: [[
                            {
                                field: 'id',
                                title: 'id',
                                width: 100,
                                hidden: 'true',
                                align: 'center'
                            }, {
                                field: 'drawingId',
                                title: '图纸编号',
                                width: 100,
                                align: 'center',
                                formatter: function (value, rows) {
                                    if (rows.drawing) {
                                        return rows.drawing.drawingId;
                                    } else
                                        return '';
                                }

                            }, {
                                field: 'name',
                                title: '图纸名称',
                                width: 100,
                                align: 'center',
                                formatter: function (value, rows) {
                                    if (rows.drawing) {
                                        return rows.drawing.name;
                                    } else
                                        return '';
                                }
                            }
                        ]]
                    });
                }
            });
        }

        //小图纸
        function loadProcess(){
            //下方子图部分的列
            $("#addSon").datagrid({
                columns:[[
                   {
                        field:'id',
                        title:'id',
                        width:100,
                        hidden:'true',
                        align:'center'
                    },{
                        field:'drawingId',
                        title:'图纸编号',
                        width:100,
                        align:'center',
                        formatter: function (value, rows) {
                            if(rows.drawing){
                                return rows.drawing.drawingId;
                            }
                            else
                                return '';
                        }

                    },{
                        field:'drawingId',
                        title:'图纸名称',
                        width:100,
                        align:'center',
                        formatter: function (value, rows) {
                            if(rows.drawing){
                                return rows.drawing.name;
                            }
                            else
                                return '';
                        }
                    }
                ]]
            });

        }

        var rows;
        var row;
        function panduan() {
            rows = $("#dg").datagrid("getSelected");
            row = $("#addSon").datagrid("getRows");
            if(rows.length == 0){
                $.messager.alert("系统提示","请选择大图纸信息");
                return false;
            }
            if (row.length == 0){
                $.messager.alert("系统提示","无小图纸信息，不得入库！");
                return false;
            }
            return true;
        }


        function goIn() {
            if(panduan()){
                $.post("/admin/storage/save",{
                    saleListId:row[0].saleList.id,
                    bigDrawingId:rows.tuzhiId,
                    drawingId:row[0].drawing.id,
                    state:"生产完成",
                    standard:"合格",
                    remark:"合格"
                },function (result) {
                    if(result.success){
                        /*alert("操作成功");
                        window.location.reload();*/
                        printt(result.id);
                    }
                },"json")
            }else {
                return;
            }
        }

        //点击打印按钮触发
        var url = "https://cli.im/api/qrcode/code?text=";

        function printt(id) {
            alert(id);
            url = "";
            $.ajax({
                type: "POST",
                async: false,
                url: "/admin/storage/findById?id=" + id,
                success: function (result) {
                    if (result.data != null) {
                        var row = result.data;
                        console.log(row);
                        var json = {};
                        json.id = row.id + "";//条码
                        if (json.id.length < 8) {
                            var j = "";
                            for (var i = 8 - json.id.length; i > 0; i--) {
                                j += "0";
                            }
                            json.id = j + json.id;
                        }
                        url = "id:" + json.id;

                        $.ajax({
                            type: "POST", async: false, url: "/static/erweima", data: {
                                url: url
                            }, success: function (result) {
                                var url = "<img style='width:auto;height: 100%;' src='" + result.url + "'/>";
                                console.log(url);
                                tableString = "";
                                tableString += "<div id='tab' style='text-align: center;width: 100%;font-size: 45px; font-weight: 900;'><table style='width: 100%;text-align: left;'><tr><td rowspan='12' style='text-align: center;'>" + url + "<div style='margin-top: 10px'>编号：" + json.id + "</div>";
                                "</td>";
                                /*tableString += "<td colspan='2'>产品名称：" + row.name + "</td></tr>";
                                if ($('#printWeight').is(':checked')) {
                                    if (row.dabaonum != 1) {
                                        tableString += "<tr><td colspan='2'>重量：" + row.realityweight + "kg x " + row.dabaonum + "件</td></tr>";
                                    } else {
                                        tableString += "<tr><td colspan='2'>重量：" + row.realityweight + "kg</td></tr>";
                                    }
                                }
                                if ($('#printLabel').is(':checked')) {
                                    tableString += "<tr><td colspan='2'>颜色：" + row.color + "</td></tr>";
                                }
                                if ($('#printLength').is(':checked')) {
                                    tableString += "<tr><td colspan='2'>压边：" + row.dao + "</td></tr>";
                                }
                                tableString += "<tr><td>客户：" + row.clientname + "</td>" + "<td>农户：" + row.peasant + "</td></tr>";
                                if (isNaN(row.price)){
                                    tableString += "<tr><td>幅宽：" + row.model + "m</td><td>厚度：" + row.price + "</td></tr>";
                                } else {
                                    tableString += "<tr><td>幅宽：" + row.model + "m</td><td>厚度：" + row.price + "mm</td></tr>";
                                }
                                if (row.hebingLength != null) {
                                    tableString += "<tr><td>长度：" + row.hebingLength + "</td><td>机台：" + row.jiTai.name + "</td></tr>";
                                } else {
                                    if ($("#changdu").val()){
                                        tableString += "<tr><td>长度：" + $('#changdu').val() + "m</td><td>机台：" + row.jiTai.name + "</td></tr>";
                                    } else {
                                        tableString += "<tr><td>长度：" + row.length + "m</td><td>机台：" + row.jiTai.name + "</td></tr>";
                                    }
                                }
                                tableString += "<tr><td>班组：" + row.jiTai.group.name + "</td><td>质检：" + row.jiTai.clerk.name + "</td></tr>";
                                Date.prototype.format = function (format) {
                                    var o = {
                                        "M+": this.getMonth() + 1,
                                        "d+": this.getDate(),
                                        "h+": this.getHours(),
                                        "m+": this.getMinutes(),
                                        "s+": this.getSeconds(),
                                        "q+": Math.floor((this.getMonth() + 3) / 3),
                                        "S": this.getMilliseconds()
                                    }
                                    if (/(y+)/.test(format)) {
                                        format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
                                    }

                                    for (var k in o) {
                                        if (new RegExp("(" + k + ")").test(format)) {
                                            format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
                                        }
                                    }
                                    return format;
                                }
                                tableString += "<td colspan='2'>时间：" + new Date().format("yyyy-MM-dd hh:mm:ss");*/
                                tableString += "</td></tr></table></div>";
                                if (window.showModalDialog) {
                                    window.showModalDialog(
                                        "/production/print.html",
                                        tableString,
                                        "location:No;status:No;help:No;dialogWidth:800px;dialogHeight:600px;scroll:auto;");
                                } else {
                                    window.open(
                                        "/production/print.html",
                                        tableString,
                                        "location:No;status:No;help:No;dialogWidth:800px;dialogHeight:600px;scroll:auto;");
                                }
                            }
                        });
                    } else {
                        $.messager.alert("系统错误", "<span style='color: red'>没有该编号的信息!</span>");
                        return;
                    }
                }
            });
        }

        function baofei(){
            if(panduan()){
                $("#dlg").dialog("open").dialog("setTitle","添加报废原因");
            }else {
                return;
            }
        }

        function closeDialog() {
            $("#dlg").dialog("close");
        }

        function okBaoFei() {
            $.post("/admin/storage/save",{
                saleListId:row[0].saleList.id,
                bigDrawingId:rows.tuzhiId,
                drawingId:row[0].drawing.id,
                state:"生产完成",
                standard:"报废",
                remark:$("#remark").val()
            },function (result) {
                if(result.success){
                    alert("操作成功");
                    window.location.reload();
                }
            },"json")
        }

        function resetValue() {
            $("#remark").val("");
        }

        function fanxiu() {
            if(panduan()){
                $.post("/admin/saleList/fanXiu",{
                    saleListId:row[0].saleList.id,
                    state:"返修"
                },function (result) {
                    if(result.success){
                        alert("成功");
                        window.location.reload();
                    }
                    else {
                        alert("失败");
                    }
                },"json")
            }else {
                return;
            }

        }

        function search() {
            $("#dg").datagrid({
                url:'/admin/saleList/findBySaleNumber',
                queryParams:{
                    saleNumber:$("#saleNumber").val()
                }
            });
            $("#addSon").datagrid("loadData", []);
        }

        //刷新
        function reload() {
            window.location.reload();
        }


    </script>
</head>    <!--上面的dg  下面的addSon-->
<body class="easyui-layout" style="margin: 1px">
<div region="north" style="height: 300px">
    <table id="dg" class="easyui-datagrid"
           fitColumns="false" rownumbers="true" singleSelect="true" fit="true"
           toolbar="#tb1" split="true">
        <thead>
        <th field="saleNumber" width="150" align="center">销售单号
        </th>
        <th field="saleDate" width="100" align="center"
            formatter="formatDate">销售日期
        </th>
        <th field="kucunzuzhi" width="100" align="center">库存组织
        </th>
        <th field="hangHao" width="100" align="center">行号
        </th>
        <th field="wuliaoId" width="150" align="center">物料编号</th>
        <th field="tuzhiName" width="100" align="center">图纸名称</th>
        <th field="tuzhiId" width="100" align="center">图纸编号</th>
        <th field="num" width="200" align="center">数量</th>
        <th field="xiangmuId" width="100" align="center">项目号</th>
        <th field="shenqingNumber" width="100" align="center">申请单号</th>
        </thead>
    </table>

    <!-- dg顶部工具栏 -->
    <div id="tb1">
        <fieldset style="border-color: #E7F0FF">
            &nbsp;销售单号&nbsp; <input type="text" id="saleNumber" size="15"
                                   onkeydown="if(event.keyCode==13) search()"/>
            &nbsp;&nbsp;<a href="javascript:search()"
                           class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>
            &nbsp;&nbsp;<a href="javascript:reload()"
                           class="easyui-linkbutton" iconCls="icon-reload" plain="true">刷新</a>
            &nbsp;&nbsp;<a href="javascript:goIn()"
                           class="easyui-linkbutton" iconCls="icon-ok" plain="true">合格</a>
            &nbsp;&nbsp;<a href="javascript:baofei()"
                           class="easyui-linkbutton" iconCls="icon-no" plain="true">报废</a>
            &nbsp;&nbsp;<a href="javascript:fanxiu()"
                           class="easyui-linkbutton" iconCls="icon-refresh" plain="true">返修</a>
        </fieldset>
    </div>
</div>

<div region="center" style="margin-top: 5px">
    <table id="addSon" class="easyui-datagrid" fitColumns="false" singleSelect="true"
           rownumbers="true" fit="true" split="true" toolbar="#tb2">
    </table>
    <thead>
    <th field="id" width="150" align="center">id
    </th>
    <th field="DrawingId" width="100" align="center">图纸编号
    </th>
    <th field="name" width="100" align="center">图纸名称
    </th>
    </thead>
</div>

<div id="dlg" class="easyui-dialog"
     style="width: 400px; height: 200px; padding: 10px 20px" closed="true"
     buttons="#dlg-buttons" data-options="onClose:function(){resetValue()}">
    <form id="fm" method="post" enctype="multipart/form-data">
        <table cellspacing="8px">
            <tr>
                <td valign="top">报废原因：</td>
                <td><textarea rows="4" cols="35" id="remark" name="remark"></textarea>
                </td>
            </tr>
        </table>
    </form>
</div>

<div id="dlg-buttons">
    <a href="javascript:okBaoFei()" class="easyui-linkbutton"
       iconCls="icon-ok">确认报废</a> <a href="javascript:closeDialog()"
                                   class="easyui-linkbutton" iconCls="icon-cancel">关闭</a>
</div>



</body>
</html>