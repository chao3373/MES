<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>生产情况</title>
    <link rel="stylesheet" type="text/css" href="/static/jquery-easyui-1.3.3/themes/bootstrap/easyui.css"></link>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/icon.css"></link>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/static/js/date.js"></script>
    <script type="text/javascript" src="../js/main.js"></script>
    <script type="text/javascript">
        //格式化日期
        Date.prototype.format = function (formatStr) {
            var str = formatStr;
            var Week = ['日', '一', '二', '三', '四', '五', '六'];
            str = str.replace(/yyyy|YYYY/, this.getFullYear());
            str = str.replace(/MM/,
                (this.getMonth() + 1) > 9 ? (this.getMonth() + 1).toString()
                    : '0' + (this.getMonth() + 1));
            str = str.replace(/dd|DD/, this.getDate() > 9 ? this.getDate()
                .toString() : '0' + this.getDate());
            return str;
        }
        //显示时间数据时先进行格式化
        function formatDate(val, row) {
            var dateType = "";
            var date = new Date();
            date.setTime(val);
            dateType = date.format("yyyy-MM-dd")
            return dateType;
        }
        //字符串转日期
        function strToDate(val) {
            var dateType = "";
            var date = new Date(val).getTime();
            return date;
        }
        function strDate(val) {
            var dateType = "";
            var date = new Date(val).format("yyyy-MM-dd");
            return date;
        }
        $(document).ready(function () {
            load();
        });


        function load() {
            $("#dg").datagrid({
                url:"/admin/clerkProduct/findAll",
                columns: [[
                    {
                        field: 'id',
                        title: '编号',
                        width: 100,
                        align: 'center',
                        hidden:'true'
                    }, {
                        field: 'saleNumber',
                        title: '订单号',
                        width: 120,
                        align: 'center',
                        formatter: function (value, rows) {
                            if (rows.drawingProcess.saleList) {
                                return rows.drawingProcess.saleList.saleNumber;
                            } else {
                                return '';
                            }
                        }
                    }, {
                        field: 'informNum',
                        title: '生产通知单号',
                        width: 120,
                        align: 'center',
                        formatter: function (value, rows) {
                            if (rows.drawingProcess) {
                                return rows.drawingProcess.informNum;
                            } else {
                                return '';
                            }
                        }
                    }, {
                        field: 'process_id',
                        title: '工序',
                        width: 120,
                        align: 'center',
                        formatter:function (value,rows) {
                            if(rows.drawingProcess.process){
                                return rows.drawingProcess.process.name;
                            }
                            else {
                                return '';
                            }
                        }
                    }, {
                        field: 'clerk_id',
                        title: '生产人员',
                        width: 120,
                        align: 'center',
                        formatter:function (value,rows) {
                            if(rows.clerk){
                                return rows.clerk.name;
                            }
                            else {
                                return '';
                            }
                        }
                    },{
                        field:'num',
                        title:'工作数量',
                        width:120,
                        align:'center'
                    },{
                        field:'dateInProduct',
                        title:'生产日期',
                        width:120,
                        align:'center',
                        formatter: function (value, row, index) {
                            if (value) {
                                var date = new Date(value);
                                var o = {
                                    "M+": date.getMonth() + 1,                 //月份
                                    "d+": date.getDate(),                    //日
                                    "h+": date.getHours(),                   //小时
                                    "m+": date.getMinutes(),                 //分
                                    "s+": date.getSeconds(),                 //秒
                                    "q+": Math.floor((date.getMonth() + 3) / 3), //季度
                                    "S": date.getMilliseconds()             //毫秒
                                };
                                if (/(y+)/.test("yyyy-MM-dd hh:mm:ss"))
                                    var fmt = "yyyy-MM-dd hh:mm:ss".replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
                                for (var k in o)
                                    if (new RegExp("(" + k + ")").test(fmt))
                                        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                                return fmt;
                            } else {
                                return "";
                            }
                        }
                    }]]
            });
        }


        //
        function daochu(dg) {
            var fields = $("#dg").datagrid('getColumnFields');
            var datagridTitle = new Array();
            for (var i = 0; i < fields.length; i++) {
                var option = $("#dg").datagrid('getColumnOption', fields[i]);
                if (option.field != "checkItem" && option.hidden != "true") { //过滤勾选框和隐藏列
                    var obj = {};
                    obj.title = option.title;
                    obj.field = option.field;
                    if (option.formatter) {
                        obj.formatter = option.formatter;
                    }
                    datagridTitle.push(obj);
                }
            }
            console.log(datagridTitle);

            var jsonarr = [];
            var rows = $(dg).datagrid("getRows");
            for (var i = 0; i < rows.length; i++) {
                var json = {};
                console.log(rows[i]);
                for (var j = 0; j < datagridTitle.length; j++) {
                    var st = datagridTitle[j].title;
                    if (datagridTitle[j].formatter) {
                        json[datagridTitle[j].title] = datagridTitle[j].formatter(rows[datagridTitle[j].field], rows[i]);
                    } else {
                        json[datagridTitle[j].title] = rows[i][datagridTitle[j].field];
                    }
                }
                console.log(JSON.stringify(json));
                jsonarr.push(JSON.stringify(json));
            }

            jsonarr = "[" + jsonarr.join(",") + "]";
            console.log(jsonarr);
            alert(jsonarr);

            $.ajax({
                type: "POST",
                url: "/admin/daochu?title=订单追踪",
                data: {a: jsonarr},
                success: function (result) {
                    if (result.success) {
                        $.messager.alert("系统提示", "导出成功");
                    }
                    return;
                }
            });

        }

        function refresh() {
            location.reload();
        }

        //按照条件查询
        function search() {
            $("#fm").form('submit', {
                url: "/admin/clerkProduct/findShengchan",
                success: function (result) {
                    if (result != null) {
                        var obj = eval('(' + result + ')');
                        if (obj.success) {
                            $("#dg").datagrid("loadData", obj.rows);
                        }
                    }
                }
            });


        }


    </script>
</head>
<body style="margin: 1px" class="easyui-layout">
<div data-options="region:'center'" style="padding: 10px; border: 1px;">
    <table id="dg" class="easyui-datagrid"
           rownumbers="true" singleSelect="true"
           toolbar="#tb" fit="true">
    </table>
    <div id="tb" style="padding: 3px;">
        <form id="fm">
            <table>
                <tr>
                    <td>
                        &nbsp;&nbsp;&nbsp;&nbsp;通知单号： <input id="informNum" name="drawingProcess.informNum" style="width: 130px"/>
                    </td>
                    <td>
                        &nbsp;&nbsp;&nbsp;&nbsp;生产人员：<input class="easyui-combobox" id="clerk" name="clerk"
                                    style="width: 100px" data-options="panelHeight:'auto',
            valueField:'id',textField:'name',url:'/admin/clerk/combobox'"/>
                    </td>
                    <td>&nbsp;&nbsp;&nbsp;&nbsp;工序： <input class="easyui-combobox" id="process" name="drawingProcess.process"
                    style="width: 100px;" data-options="panelHeight:'auto',
                valueField:'id',textField:'name',url:'/admin/process/processCombobox'"/>
                    </td>
                    <td>&nbsp;&nbsp;&nbsp;&nbsp;生产日期：&nbsp;<input
                            type="text" id="dateInProducedd" name="dateInProducedd" class="easyui-datebox"
                            demandd="true" size="15"/></td>
                    <td>&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:search()"
                                                   class="easyui-linkbutton" iconCls="icon-search">查询</a>
                    </td>
                    <td>
                        &nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:refresh()" class="easyui-linkbutton"
                                                   iconCls="icon-reload">刷新</a>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>

</body>
</html>