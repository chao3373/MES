<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>销售订单追踪</title>
    <link rel="stylesheet" type="text/css" href="/static/jquery-easyui-1.3.3/themes/bootstrap/easyui.css"></link>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/icon.css"></link>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/static/js/date.js"></script>
    <script type="text/javascript" src="../js/main.js"></script>
    <script type="text/javascript">
        //格式化日期
        Date.prototype.format = function (formatStr) {
            var str = formatStr;
            var Week = ['日', '一', '二', '三', '四', '五', '六'];
            str = str.replace(/yyyy|YYYY/, this.getFullYear());
            str = str.replace(/MM/,
                (this.getMonth() + 1) > 9 ? (this.getMonth() + 1).toString()
                    : '0' + (this.getMonth() + 1));
            str = str.replace(/dd|DD/, this.getDate() > 9 ? this.getDate()
                .toString() : '0' + this.getDate());
            return str;
        }
        //显示时间数据时先进行格式化
        function formatDate(val, row) {
            var dateType = "";
            var date = new Date();
            date.setTime(val);
            dateType = date.format("yyyy-MM-dd")
            return dateType;
        }
        //字符串转日期
        function strToDate(val) {
            var dateType = "";
            var date = new Date(val).getTime();
            return date;
        }
        function strDate(val) {
            var dateType = "";
            var date = new Date(val).format("yyyy-MM-dd");
            return date;
        }
        $(document).ready(function () {
            load();
        });

        var id;
        function jindu() {
            id = $("#dg").datagrid("getSelected").id;
            $("#dlg").dialog("open").dialog("setTitle","查看订单进度");
            loaddg2();
        }

        function loaddg2() {
            $("#dg2").datagrid({
                url:"/admin/drawingType/findBySaleListId?id="+id,
                columns:[[
                    {
                        field: 'id',
                        title: '编号',
                        width: 100,
                        align: 'center',
                        hidden:'true'
                    },{
                        field: 'drawingId',
                        title: '小图纸编号',
                        width: 100,
                        align: 'center',
                        formatter: function (value, rows) {
                            if(rows.drawing){
                                return rows.drawing.drawingId;
                            }
                            else
                                return '';
                        }
                    },{
                        field: 'drawingName',
                        title: '小图纸名称',
                        width: 100,
                        align: 'center',
                        formatter: function (value, rows) {
                            if(rows.drawing){
                                return rows.drawing.name;
                            }
                            else
                                return '';
                        }
                    },{
                        field: 'state',
                        title: '状态',
                        width: 100,
                        align: 'center'
                    }
                ]]
            });
        }

        function load() {
            $("#dg").datagrid({
                url:"/admin/saleList/findAll",
                columns: [[
                    {
                        field: 'id',
                        title: '编号',
                        width: 100,
                        align: 'center',
                        hidden:'true'
                    }, {
                        field: 'saleNumber',
                        title: '订单号',
                        width: 120,
                        align: 'center',
                        formatter:function (value) {
                            var str = '<a href="javascript:jindu()" id="jindu" name="jindu" class="easyui-linkbutton">'+value+'</a>';
                            return str;
                        }
                    }, {
                        field: 'hangHao',
                        title: '行号',
                        width: 100,
                        align: 'center'
                    }, {
                        field: 'wuliaoId',
                        title: '物料编号',
                        width: 100,
                        align: 'center'
                    }, {
                        field: 'tuzhiId',
                        title: '图纸编号',
                        width: 100,
                        align: 'center'
                    }, {
                        field: 'tuzhiName',
                        title: '图纸名称',
                        width: 100,
                        align: 'center'
                    }, {
                        field: 'xiangmuId',
                        title: '项目编号',
                        width: 100,
                        align: 'center'
                    }, {
                        field: 'shenqingNumber',
                        title: '申请单号',
                        width: 100,
                        align: 'center'
                    }, {
                        field: 'kucunzuzhi',
                        title: '库存组织',
                        width: 100,
                        align: 'center'
                    }, {
                        field: 'state',
                        title: '订单状态',
                        width: 100,
                        align: 'center'
                    }, {
                        field: 'prepareTime',
                        title: '准备工时',
                        width: 100,
                        align: 'center'
                    }, {
                        field: 'saleDate',
                        title: '销售日期',
                        width: 130,
                        align: 'center',
                        formatter: function (value, row, index) {
                            if (value) {
                                var date = new Date(value);
                                var o = {
                                    "M+": date.getMonth() + 1,                 //月份
                                    "d+": date.getDate(),                    //日
                                    "h+": date.getHours(),                   //小时
                                    "m+": date.getMinutes(),                 //分
                                    "s+": date.getSeconds(),                 //秒
                                    "q+": Math.floor((date.getMonth() + 3) / 3), //季度
                                    "S": date.getMilliseconds()             //毫秒
                                };
                                if (/(y+)/.test("yyyy-MM-dd hh:mm:ss"))
                                    var fmt = "yyyy-MM-dd hh:mm:ss".replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
                                for (var k in o)
                                    if (new RegExp("(" + k + ")").test(fmt))
                                        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                                return fmt;
                            } else {
                                return "";
                            }
                        }
                    },{
                        field: 'referDate',
                        title: '需交日期',
                        width: 130,
                        align: 'center',
                        formatter: function (value, row, index) {
                            if (value) {
                                var date = new Date(value);
                                var o = {
                                    "M+": date.getMonth() + 1,                 //月份
                                    "d+": date.getDate(),                    //日
                                    "h+": date.getHours(),                   //小时
                                    "m+": date.getMinutes(),                 //分
                                    "s+": date.getSeconds(),                 //秒
                                    "q+": Math.floor((date.getMonth() + 3) / 3), //季度
                                    "S": date.getMilliseconds()             //毫秒
                                };
                                if (/(y+)/.test("yyyy-MM-dd hh:mm:ss"))
                                    var fmt = "yyyy-MM-dd hh:mm:ss".replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
                                for (var k in o)
                                    if (new RegExp("(" + k + ")").test(fmt))
                                        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                                return fmt;
                            } else {
                                return "";
                            }
                        }
                    }]]
            });
        }


        //
        function daochu(dg) {
            var fields = $("#dg").datagrid('getColumnFields');
            var datagridTitle = new Array();
            for (var i = 0; i < fields.length; i++) {
                var option = $("#dg").datagrid('getColumnOption', fields[i]);
                if (option.field != "checkItem" && option.hidden != "true") { //过滤勾选框和隐藏列
                    var obj = {};
                    obj.title = option.title;
                    obj.field = option.field;
                    if (option.formatter) {
                        obj.formatter = option.formatter;
                    }
                    datagridTitle.push(obj);
                }
            }
            console.log(datagridTitle);

            var jsonarr = [];
            var rows = $(dg).datagrid("getRows");
            for (var i = 0; i < rows.length; i++) {
                var json = {};
                console.log(rows[i]);
                for (var j = 0; j < datagridTitle.length; j++) {
                    var st = datagridTitle[j].title;
                    if (datagridTitle[j].formatter) {
                        json[datagridTitle[j].title] = datagridTitle[j].formatter(rows[datagridTitle[j].field], rows[i]);
                    } else {
                        json[datagridTitle[j].title] = rows[i][datagridTitle[j].field];
                    }
                }
                console.log(JSON.stringify(json));
                jsonarr.push(JSON.stringify(json));
            }

            jsonarr = "[" + jsonarr.join(",") + "]";
            console.log(jsonarr);
            alert(jsonarr);

            $.ajax({
                type: "POST",
                url: "/admin/daochu?title=订单追踪",
                data: {a: jsonarr},
                success: function (result) {
                    if (result.success) {
                        $.messager.alert("系统提示", "导出成功");
                    }
                    return;
                }
            });

        }

        function refresh() {
            location.reload();
        }

       /* var json;
        function addScreen() {
            json = {};

            if($("#saleNumber").val()){
                json.saleNumber = $("#saleNumber").val();
            }
            if($("#shenqingNumber").val()){
                json.shenqingNumber = $("#shenqingNumber").val();
            }
            if($("#xiangmuId").val()){
                json.xiangmuId = $("#xiangmuId").val();
            }
            if($("#tuzhiId").val()){
                json.tuzhiId = $("#tuzhiId").val();
            }
            if($("#saleDate").datebox("getValue")){
                json.saleDate = $("#saleDate").datebox("getValue");
            }
            if($("#wuliaoId").val()){
                json.wuliaoId = $("#wuliaoId").val();
            }

            console.log(json)

        }
        function refreshData() {
            $.post("/admin/saleList/dingDanZhuiZong",json, function (result) {
                if (result.success) {
                    $("#dg").datagrid('loadData', result.rows);
                }
            },"json")
        }

        function search() {
            addScreen();
            refreshData();
        }*/

        function search() {
            $("#fm").form('submit', {
                url: "/admin/saleList/dingDanZhuiZong",
                success: function (result) {
                    if (result != null) {
                        var obj = eval('(' + result + ')');
                        if (obj.success) {
                            $("#dg").datagrid("loadData", obj.rows);
                        }
                    }
                }
            });
        }
    </script>
</head>
<body style="margin: 1px" class="easyui-layout">
<div data-options="region:'center'" style="padding: 10px; border: 1px;">
    <table id="dg" class="easyui-datagrid"
           rownumbers="true" singleSelect="true"
           toolbar="#tb" fit="true">
    </table>
    <div id="tb" style="padding: 3px;">
        <form id="fm">
            <table>
                <tr>
                    <td>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;订&nbsp;单&nbsp;号： <input name="SaleNumber" id="saleNumber" style="width: 130px"/>
                    </td>
                    <td>
                        &nbsp;&nbsp;&nbsp;&nbsp;申请单号： <input name="ShenqingNumber" id="shenqingNumber" style="width: 130px"/>
                    </td>
                    <td>
                        &nbsp;&nbsp;&nbsp;&nbsp;项目号： <input name="XiangmuId" id="xiangmuId" style="width: 130px"/>
                    </td>

                    <td>&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:search()"
                                                    class="easyui-linkbutton" iconCls="icon-search">查询</a>
                    </td>
                </tr>
                <tr>
                    <td>
                        &nbsp;&nbsp;&nbsp;&nbsp;图纸编号： <input name="TuzhiId" id="tuzhiId" style="width: 130px"/>
                    </td>
                    <td>&nbsp;&nbsp;&nbsp;&nbsp;销售日期： <input type="text" id="aleDate" name="saleDated"
                                                            class="easyui-datebox"
                                                            demandd="true" data-options="editable:false" size="15"/>
                    </td>
                    <td>
                        &nbsp;&nbsp;&nbsp;&nbsp;物料号： <input name="WuliaoId" id="wuliaoId" style="width: 130px"/>
                    </td>
                    <!--后台需要的yaoqiu的值-->
                    &nbsp;&nbsp;&nbsp;&nbsp;<input type="hidden" name="yaoqiu" id="yaoqiu"/>
                    <td>
                        &nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:refresh()" class="easyui-linkbutton"
                                                   iconCls="icon-reload">刷新</a>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>

<div id="dlg" class="easyui-dialog" buttons="#dlg-buttons"
     style="width: 400px; height: 250px; padding: 10px 20px" closed="true">
    <table id="dg2" class="easyui-datagrid"
           rownumbers="true" singleSelect="true" fit="true">
    </table>
</div>
<div id="dlg-buttons">
    <a href="javascript:closeDlg('#dlg')"  class="easyui-linkbutton" iconCls="icon-cancel">关闭</a>
</div>
</body>
</html>