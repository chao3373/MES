<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>销售订单审核</title>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/bootstrap/easyui.css"></link>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/icon.css"></link>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/static/js/date.js"></script>
    <script type="text/javascript">
        var url;

        function formatUser(val, row) {
            return val.trueName + "&nbsp;(" + val.userName + ")&nbsp;";
        }

        function searchSale() {
            var clientId;
            var clerkId;
            if (isNaN($("#s_client").combobox("getValue"))) {
                clientId = "";
            } else {
                clientId = $("#s_client").combobox("getValue");
            }

            if (isNaN($("#s_clerk").combobox("getValue"))) {
                clerkId = "";
            } else {
                clerkId = $("#s_clerk").combobox("getValue");
            }
            $("#dg").datagrid({
                url: '/admin/saleList/list',
                queryParams: {
                    saleNumber: $("#s_saleNumber").val(),
                    clientId: clientId,
                    clerkId: clerkId,
                    bSaleDate: $("#s_bSaleDate").datebox("getValue"),
                    eSaleDate: $("#s_eSaleDate").datebox("getValue")
                }
            });
        }

        function formatSupplier(val, row) {
            return val.name;
        }

        //格式化日期
        Date.prototype.format = function (formatStr) {
            var str = formatStr;
            var Week = ['日', '一', '二', '三', '四', '五', '六'];
            str = str.replace(/yyyy|YYYY/, this.getFullYear());
            str = str.replace(/MM/,
                (this.getMonth() + 1) > 9 ? (this.getMonth() + 1).toString()
                    : '0' + (this.getMonth() + 1));
            str = str.replace(/dd|DD/, this.getDate() > 9 ? this.getDate()
                .toString() : '0' + this.getDate());
            return str;
        }

        //显示时间数据时先进行格式化
        function formatDate(val, row) {
            var dateType = "";
            var date = new Date();
            date.setTime(val);
            dateType = date.format("yyyy-MM-dd")
            return dateType;
        }

        //字符串转日期
        function strToDate(val) {
            var dateType = "";
            var date = new Date(val).getTime();
            return date;
        }

        function strDate(val) {
            var dateType = "";
            var date = new Date(val).format("yyyy-MM-dd");
            return date;
        }


        function formatUser(val, row) {
            return val.trueName + "&nbsp;(" + val.userName + ")&nbsp;";
        }

        $(document).ready(function () {

        });


        var ids;

        //审核
        function auditResult(value) {
            var selectedRows = $("#dg2").datagrid("getSelections");
            if (selectedRows.length == 0) {
                $.messager.alert("系统提示", "请选择要审核的信息！");
                return;
            }
            var strIds = [];
            for (var i = 0; i < selectedRows.length; i++) {
                strIds.push(selectedRows[i].id);
            }
            ids = strIds.join(",");
            //审核成功
            if (value == 1) {
                $.messager
                    .confirm(
                        "系统提示",
                        "您确定审核这些数据吗？",
                        function (r) {
                            if (r) {
                                $
                                    .post(
                                        "/admin/saleListProduct/passTheAudit",
                                        {
                                            ids: ids
                                        },
                                        function (result) {
                                            if (result.success) {
                                                $.messager.alert(
                                                    "系统提示",
                                                    "审核已通过!");
                                                $
                                                    .post(
                                                        "/admin/saleListProduct/listAllBySaleList",
                                                        {
                                                            id: $(
                                                                "#dg")
                                                                .datagrid(
                                                                    "getSelections")[0].id
                                                        },
                                                        function (
                                                            data) {
                                                            if (data.success) {

                                                            }
                                                        });
                                                $("#dg")
                                                    .datagrid(
                                                        "selectRecord",
                                                        $(
                                                            "#dg")
                                                            .datagrid(
                                                                "getSelections")[0].id);
                                                console
                                                    .log($(
                                                        "#dg")
                                                        .datagrid(
                                                            "getSelections")[0].id);
                                                $("#dg2").datagrid(
                                                    "reload");
                                            } else {
                                                $.messager
                                                    .alert(
                                                        "系统提示",
                                                        result.errorInfo);
                                            }
                                        });

                            }
                        });
            } else if (value == 0) {//审核失败
                $("#dlg").dialog("open");
            }
        }

        //提交审核未通过原因
        function saveCause() {
            var cause = "审核失败：" + $("#cause").val();
            alert(cause);
            alert("saveCause" + ids);
            $.post("/admin/saleListProduct/auditFailure", {
                ids: ids,
                cause: cause
            }, function (result) {
                if (result.success) {
                    $.messager.alert("系统提示", "审核结果已提交");
                    $("#dg2").datagrid("reload");
                } else {
                    $.messager.alert("系统提示", result.errorInfo);
                }
            });
            closeCause();
        }
    </script>
</head>
<body class="easyui-layout" style="margin: 1px">
<div region="north" style="height: 300px">
    <table id="dg" title="销售单据查询" class="easyui-datagrid"
           fitColumns="false" rownumbers="true" singleSelect="true" fit="true"
           toolbar="#tb" split="true">
        <thead>
        <th field="id" width="20" align="center">销售单号</th>
        <th field="saleNumber" width="150" align="center">销售单号</th>
        <th field="saleDate" width="100" align="center"
            formatter="formatDate">销售日期
        </th>
        <th field="client" width="100" align="center"
            formatter="formatSupplier">客户
        </th>
        <th field="clerk" width="100" align="center"
            formatter="formatSupplier">业务员
        </th>
        <th field="user" width="150" align="center" formatter="formatUser">操作员</th>
        <th field="lankman" width="100" align="center">联系人</th>
        <th field="tel" width="100" align="center">客户电话</th>
        <th field="address" width="200" align="center">客户地址</th>
        <th field="deliveryDate" width="100" align="center"
            formatter="formatDate">发货时间
        </th>
        <th field="remark" width="100" align="center">备注</th>
        </thead>
    </table>

    <!-- dg顶部工具栏 -->
    <div id="tb">
        <fieldset style="border-color: #E7F0FF">
            <legend>查询设置</legend>
            &nbsp;单据号&nbsp; <input type="text" id="s_saleNumber" size="15"
                                   onkeydown="if(event.keyCode==13) searchSale()"/>
            &nbsp;&nbsp;&nbsp;日期：&nbsp; <input id="s_bSaleDate"
                                               class="easyui-datebox" editable=false style="width: 100px"/>
            &nbsp;&nbsp;&nbsp;&nbsp; <input id="s_eSaleDate"
                                             class="easyui-datebox" editable=false style="width: 100px"/>
            &nbsp;&nbsp;<a href="javascript:searchSale()"
                           class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>
            &nbsp;&nbsp;<a href="javascript:openRoleModifyDialog()"
                           class="easyui-linkbutton" iconCls="icon-edit" plain="true">修改</a>
        </fieldset>
    </div>
</div>

<!--<div region="center" style="margin-top: 5px">
    <table id="dg2" class="easyui-datagrid" fitColumns="false"
           rownumbers="true" fit="true" split="true" toolbar="#tb2">
    </table>
</div>

<div id="tb2">
    <div>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:auditResult(1)"
                                         class="easyui-linkbutton" iconCls="icon-ok" plain="true">审核通过</a>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:auditResult(0)"
                                         class="easyui-linkbutton" iconCls="icon-no" plain="true">审核失败</a>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;订单状态：&nbsp;
        &lt;!&ndash; <input id="combo" class="easyui-combobox" style="width:120px;" /> &ndash;&gt;
        &lt;!&ndash; <input id="cc" name="dept" /> &ndash;&gt;
        <input id="cc1" class="easyui-combobox"
               data-options="
			panelHeight: 'auto',
		    valueField: 'label',
		    textField: 'value',
		    data: [{
					label: '未审核',
					value: '未审核'
				},{
					label: '审核通过',
					value: '审核通过'
				},{
					label: '下发机台',
					value: '下发机台'
				},{
					label: '生产完成',
					value: '生产完成'
				},{
					label: '提货',
					value: '提货'
				},{
					label: '装车',
					value: '装车'
				}],
		    onSelect: function(rec){
		    	auditQuery(rec.value);
		    }"/>
    </div>
</div>

<div id="dlg" class="easyui-dialog" title="审核未通过原因"
     style="padding: 10px 20px" buttons="#dlg-buttons">
    &nbsp;&nbsp;&nbsp;原因：
    <textarea id="cause"
              style="margin-right: 20px; width: 300px; height: 100px; vertical-align: top; resize: none"></textarea>
</div>-->
</body>
</html>