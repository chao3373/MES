<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>销售订单审核</title>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/bootstrap/easyui.css"></link>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/icon.css"></link>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/static/js/date.js"></script>
    <script type="text/javascript">
        var url;

        function formatUser(val, row) {
            return val.trueName + "&nbsp;(" + val.userName + ")&nbsp;";
        }

        function searchSale() {
            var clientId;
            var clerkId;
            if (isNaN($("#s_client").combobox("getValue"))) {
                clientId = "";
            } else {
                clientId = $("#s_client").combobox("getValue");
            }

            if (isNaN($("#s_clerk").combobox("getValue"))) {
                clerkId = "";
            } else {
                clerkId = $("#s_clerk").combobox("getValue");
            }
            $("#dg").datagrid({
                url: '/admin/saleList/list',
                queryParams: {
                    saleNumber: $("#s_saleNumber").val(),
                    clientId: clientId,
                    clerkId: clerkId,
                    bSaleDate: $("#s_bSaleDate").datebox("getValue"),
                    eSaleDate: $("#s_eSaleDate").datebox("getValue")
                }
            });
        }

        function formatSupplier(val, row) {
            return val.name;
        }

        //格式化日期
        Date.prototype.format = function (formatStr) {
            var str = formatStr;
            var Week = ['日', '一', '二', '三', '四', '五', '六'];
            str = str.replace(/yyyy|YYYY/, this.getFullYear());
            str = str.replace(/MM/,
                (this.getMonth() + 1) > 9 ? (this.getMonth() + 1).toString()
                    : '0' + (this.getMonth() + 1));
            str = str.replace(/dd|DD/, this.getDate() > 9 ? this.getDate()
                .toString() : '0' + this.getDate());
            return str;
        }

        //显示时间数据时先进行格式化
        function formatDate(val, row) {
            var dateType = "";
            var date = new Date();
            date.setTime(val);
            dateType = date.format("yyyy-MM-dd")
            return dateType;
        }

        //字符串转日期
        function strToDate(val) {
            var dateType = "";
            var date = new Date(val).getTime();
            return date;
        }

        function strDate(val) {
            var dateType = "";
            var date = new Date(val).format("yyyy-MM-dd");
            return date;
        }


        function formatUser(val, row) {
            return val.trueName + "&nbsp;(" + val.userName + ")&nbsp;";
        }

        $(document).ready(function () {
            $('#dg').datagrid({
                rowStyler: function (index, row) {
                    if (row.cunzai == null) {
                        return 'background-color:orange;color:blue;font-weight:bold;';
                    }
                }
            });
            load();
            $("#dg").datagrid({
                url:'/admin/saleList/xiadanSuccess',
                columns: [[
                    {
                        field: 'cb',
                        checkbox: "true",
                        align: "center"
                    },{
                        field: "saleNumber",
                        width: "150",
                        align: "center",
                        title: "销售单号"
                    },{
                        field: "saleDate",
                        width: "150",
                        align: "center",
                        title: "销售日期",
                        formatter: function (value, row, index) {
                            if (value) {
                                var date = new Date(value);
                                var o = {
                                    "M+": date.getMonth() + 1,                 //月份
                                    "d+": date.getDate(),                    //日
                                    "h+": date.getHours(),                   //小时
                                    "m+": date.getMinutes(),                 //分
                                    "s+": date.getSeconds(),                 //秒
                                    "q+": Math.floor((date.getMonth() + 3) / 3), //季度
                                    "S": date.getMilliseconds()             //毫秒
                                };
                                if (/(y+)/.test("yyyy-MM-dd hh:mm:ss"))
                                    var fmt = "yyyy-MM-dd hh:mm:ss".replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
                                for (var k in o)
                                    if (new RegExp("(" + k + ")").test(fmt))
                                        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                                return fmt;
                            } else {
                                return "";
                            }
                        }
                    },{
                        field: "tuzhiName",
                        width: "150",
                        align: "center",
                        title: "图纸名称"
                    },{
                        field: "tuzhiId",
                        width: "150",
                        align: "center",
                        title: "图纸编号"
                    }
                ]],
                onClickRow:function (index,row) {
                    $("#addSon").datagrid({
                        url:"/admin/saleList/bigSmallDrawing",
                        queryParams:{
                           drawingId:row.tuzhiId
                        },
                        columns:[[
                            {
                                field:'id',
                                title:'id',
                                width:100,
                                hidden:'true',
                                align:'center'
                            },{
                                field:'drawingId',
                                title:'图纸编号',
                                width:100,
                                align:'center'
                            },{
                                field:'name',
                                title:'图纸名称',
                                width:100,
                                align:'center'
                            }
                        ]]
                    });
                }
            });

        });




        //打开子图选择对话框
        function add() {
            var row = $("#dg").datagrid("getSelected");
            if(row == null){
                $.messager.alert("系统提示","请选择订单信息");
                return;
            }
            if(row.cunzai == null){
                $.messager.alert("系统提示","请先添加大图信息");
                return;
            }
            $("#addSonDrawing").dialog("open").dialog("setTitle", "选择子图");
        }

        //弹出的对话框中的值
        function load(){
            $("#son").datagrid({
                columns:[[
                    {
                        field: 'cb',
                        checkbox: "true",
                        align: "center"
                    },{
                        field:'id',
                        title:'id',
                        width:100,
                        hidden:'true',
                        align:'center'
                    },{
                        field:'drawingId',
                        title:'图纸编号',
                        width:100,
                        align:'center'
                    },{
                        field:'name',
                        title:'图纸名称',
                        width:100,
                        align:'center'
                    }
                ]]
            });

            //下方子图部分的列
            $("#addSon").datagrid({
                columns:[[
                    {
                        field:'id',
                        title:'id',
                        width:100,
                        hidden:'true',
                        align:'center'
                    },{
                        field:'drawingId',
                        title:'图纸编号',
                        width:100,
                        align:'center'
                    },{
                        field:'name',
                        title:'图纸名称',
                        width:100,
                        align:'center'
                    }
                ]]
            });

        }

        function addS() {
            //console.log($("#son").datagrid("getSelections"));
            var obj = $("#son").datagrid("getSelections");
            for(var i=0; i<obj.length; i++){
                $("#addSon").datagrid("appendRow",obj[i]);
            }
            $("#addSonDrawing").dialog("close");
        }

        function OK() {
            var id = $("#dg").datagrid("getSelected").id;
            var bigDrawingId = $("#dg").datagrid("getSelected").tuzhiId;
            var smallDrawing = $("#addSon").datagrid("getRows");
            console.log(smallDrawing);
            var smallArr = [];
            for(var i=0;i<smallDrawing.length;i++){
                smallArr.push(smallDrawing[i].id);
            }
            var smallIds = smallArr.join(",");
            $.post("/admin/drawingType/addSonDrawing",
                {
                    id:id,
                    bigDrawingId:bigDrawingId,
                    smallIds:smallIds
                },function (result) {
                if(result.success){
                    $.messager.alert("系统提示","添加成功");
                }
                else {
                    $.messager.alert("系统提示","添加失败");
                }
            },"json")

            //console.log(smallDrawing);
        }

        //添加大图纸信息
        var rowss;
        function addBidDrawingInfo(){
            rowss = $("#dg").datagrid("getSelected");
            if(rowss.cunzai != null){
                $.messager.alert("系统提示","大图信息已存在");
                return;
            }
            $("#dlg").dialog("open").dialog("setTitle","添加图纸信息");
            $("#add-name").val(rowss.tuzhiName);
            $("#add-drawingId").val(rowss.tuzhiId);
        }

        //关闭添加大图对话框
        function closeDialog() {
            $("#dlg").dialog("close");
        }


        //保存大图信息
        function saveRole() {
            $("#fm").form("submit", {
                url : "/admin/bigdrawing/save",
                success : function(result) {
                    var result = eval('(' + result + ')');
                    if (result.success) {
                        $.messager.alert("系统提示", "保存成功！");
                        $.post("/admin/saleList/addCunZai",{
                            id:rowss.id
                        },function(){
                        },"json")
                        $("#dlg").dialog("close");
                        $("#dg").datagrid("reload");
                    } else {
                        $.messager.alert("系统提示", result.errorInfo);
                    }
                }
            });
        }



        function saveProcess() {
            var row = $("#addSon").datagrid("getSelected");
            var rows = $("#dg").datagrid("getSelected");
            console.log(row.id);
            $.post("/admin/process/saveProcess",
                {
                    DrawingId:row.id,
                    BigDrawingId:rows.id,
                    ProcessId:$("#name").combobox("getValue"),
                    neiRong:$("#neiRong").val(),
                    manHour:$("#manHour").val()
                },function (result) {
                    if(result.success){
                        $.messager.alert("系统提示","添加成功！");
                    }
                    else{
                        $.messager.alert("系统提示","添加失败！");
                    }
                },"json");
            closedia();
        }
        //关闭添加大图对话框
        function closedia() {
            $("#dlg2").dialog("close");
        }

        function addProcess(id) {
            if(id.length<8){
                var j = "";
                for (var i = 8 - json.id.length; i > 0; i--) {
                    j += "0";
                }
            }
            j += id;
            var tm = "<img style='' src='/tm/" + j + ".png'/>";
            if (window.showModalDialog) {
                window.showModalDialog(
                    "print.html",
                    tm,
                    "location:No;status:No;help:No;dialogWidth:800px;dialogHeight:600px;scroll:auto;");
                console.log(tm);
            } else {
                window.open(
                    "print.html",
                    tm,
                    "location:No;status:No;help:No;dialogWidth:800px;dialogHeight:600px;scroll:auto;");
                console.log(tm);
            }
        }

    </script>
</head>    <!--上面的dg  下面的addSon-->
<body class="easyui-layout" style="margin: 1px">
<div region="north" style="height: 300px">
    <table id="dg" title="图纸展开审核" class="easyui-datagrid"
           fitColumns="false" rownumbers="true" singleSelect="true" fit="true"
           toolbar="#tb1" split="true">
        <thead>
        <th field="saleNumber" width="150" align="center">销售单号
        </th>
        <th field="saleDate" width="100" align="center"
            formatter="formatDate">销售日期
        </th>
        <th field="kucunzuzhi" width="100" align="center">库存组织
        </th>
        <th field="hangHao" width="100" align="center">行号
        </th>
        <th field="wuliaoId" width="150" align="center">物料编号</th>
        <th field="tuzhiName" width="100" align="center">图纸名称</th>
        <th field="tuzhiId" width="100" align="center">图纸编号</th>
        <th field="num" width="200" align="center">数量</th>
        <th field="xiangmuId" width="100" align="center">项目号</th>
        <th field="shenqingNumber" width="100" align="center">申请单号</th>
        </thead>
    </table>

    <!-- dg顶部工具栏 -->
    <div id="tb1">
        <fieldset style="border-color: #E7F0FF">
            <legend>查询设置</legend>
            &nbsp;单据号&nbsp; <input type="text" id="s_saleNumber" size="15"
                                   onkeydown="if(event.keyCode==13) searchSale()"/>
            &nbsp;&nbsp;<a href="javascript:searchSale()"
                           class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>
            &nbsp;&nbsp;<a href="javascript:addBidDrawingInfo()"
                           class="easyui-linkbutton" iconCls="icon-add" plain="true">添加大图信息</a>
            <span style="background:orange">背景色为橙色的需要添加图纸信息及所包含子图</span>
        </fieldset>
    </div>
</div>

<div region="center" style="margin-top: 5px">
    <table id="addSon" class="easyui-datagrid" fitColumns="false" singleSelect="true"
           rownumbers="true" fit="true" split="true" toolbar="#tb2">
    </table>
    <thead>
    <th field="id" width="150" align="center">id
    </th>
    <th field="DrawingId" width="100" align="center">图纸编号
    </th>
    <th field="name" width="100" align="center">图纸名称
    </th>
    </thead>
</div>

<div id="tb2">
    <div>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:add()"
                                         class="easyui-linkbutton" iconCls="icon-add" plain="true">添加子图</a>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:OK()"
                                         class="easyui-linkbutton" iconCls="icon-ok" plain="true">确定</a>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:addProcess(1)"
                                         class="easyui-linkbutton" iconCls="icon-add" plain="true">添加工时工序</a>
    </div>
</div>

<!--弹出来添加子图的对话框-->
<div class="easyui-dialog" id="addSonDrawing" fit="true" closed="true">
    <table id="son" class="easyui-datagrid" fitColumns="false"
           rownumbers="true" url="/admin/drawing/list" toolbar="#tb"
           fit="true">
    </table>
    <div id="tb" >
        <a href="javascript:addS()"
           class="easyui-linkbutton" iconCls="icon-add" plain="true">添加</a>
    </div>
</div>

<!--添加大图信息-->
<div id="dlg" class="easyui-dialog"
     style="width: 450px; height: 250px; padding: 10px 20px" closed="true"
     buttons="#dlg-buttons">
    <form id="fm" method="post" enctype="multipart/form-data">
        <table cellspacing="8px">
            <tr>
                <td>图纸名称：</td>
                <td><input type="text" id="add-name" name="name"
                           class="easyui-validatebox" required="true" /></td>
            </tr>
            <tr>
                <td>图纸编号：</td>
                <td><input type="text" id="add-drawingId" name="drawingId"
                           class="easyui-validatebox" required="true" /></td>
            </tr>
            <tr>
                <td>图纸：</td>
                <td><input id="add-drawingURL"  type="file" name="drawingURL"/></td>
            </tr>
        </table>
    </form>
</div>
<div id="dlg-buttons">
    <a href="javascript:saveRole()" class="easyui-linkbutton"
       iconCls="icon-ok">保存</a> <a href="javascript:closeDialog()"
                                   class="easyui-linkbutton" iconCls="icon-cancel">关闭</a>
</div>


<!--添加工时工序-->
<div id="dlg2" class="easyui-dialog"
     style="width: 450px; height: 250px; padding: 10px 20px" closed="true"
     buttons="#dlg-buttons2">
    <form id="fm2" method="post" enctype="multipart/form-data">
        <table cellspacing="8px">
            <tr>
                <td>工序：</td>
                <td>
                    <input class="easyui-combobox" id="name" name="name"
                style="width: 100px" data-options="panelHeight:'auto',
                valueField:'id',textField:'name',url:'/admin/process/processCombobox'" />
                </td>
            </tr>
            <tr>
                <td>工序内容：</td>
                <td><input type="text" id="neiRong" name="neiRong"
                           class="easyui-validatebox" required="true" /></td>
            </tr>
            <tr>
                <td>所需工时：</td>
                <td><input type="text" id="manHour" name="manHour"
                           class="easyui-validatebox" required="true" /></td>
            </tr>
        </table>
    </form>
</div>
<div id="dlg-buttons2">
<a href="javascript:saveProcess()" class="easyui-linkbutton"
   iconCls="icon-ok">保存</a> <a href="javascript:closedia()"
                               class="easyui-linkbutton" iconCls="icon-cancel">关闭</a>
</div>



</body>
</html>