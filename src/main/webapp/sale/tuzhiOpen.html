<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>销售订单审核</title>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/bootstrap/easyui.css"></link>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/icon.css"></link>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/static/js/date.js"></script>
    <script type="text/javascript" src="/js/main.js"></script>
    <script type="text/javascript">
        var url;

        function formatUser(val, row) {
            return val.trueName + "&nbsp;(" + val.userName + ")&nbsp;";
        }

        function searchSale() {

            var data = getFrom("#search");
            data.cunzai = "分配工时";
            data.state = "下单";
            console.log(data)

            $.ajax({
                type: "POST",
                url: "/admin/saleList/selectAboutSaleList",
                data: data,
                success: function (result) {
                    $("#dg").datagrid("loadData",result.rows)
                }
            });
        }

        function formatSupplier(val, row) {
            return val.name;
        }

        //格式化日期
        Date.prototype.format = function (formatStr) {
            var str = formatStr;
            var Week = ['日', '一', '二', '三', '四', '五', '六'];
            str = str.replace(/yyyy|YYYY/, this.getFullYear());
            str = str.replace(/MM/,
                (this.getMonth() + 1) > 9 ? (this.getMonth() + 1).toString()
                    : '0' + (this.getMonth() + 1));
            str = str.replace(/dd|DD/, this.getDate() > 9 ? this.getDate()
                .toString() : '0' + this.getDate());
            return str;
        }

        //显示时间数据时先进行格式化
        function formatDate(val, row) {
            var dateType = "";
            var date = new Date();
            date.setTime(val);
            dateType = date.format("yyyy-MM-dd")
            return dateType;
        }

        //字符串转日期
        function strToDate(val) {
            var dateType = "";
            var date = new Date(val).getTime();
            return date;
        }

        function strDate(val) {
            var dateType = "";
            var date = new Date(val).format("yyyy-MM-dd");
            return date;
        }


        function formatUser(val, row) {
            return val.trueName + "&nbsp;(" + val.userName + ")&nbsp;";
        }

        var user = "";
        $(document).ready(function () {
            loadDG2();

            //获取当前用户

            $.ajax({
                type:"post",
                async:false,
                url:"/admin/saleList/dangqianUser",
                dataType:"json",
                success:function (result) {
                    user = result.user;
                }
            });

            /*$('#dg').datagrid({
                rowStyler: function (index, row) {
                    if (row.remark == "2") {
                        return 'background: #CC2222;color:white'
                    }
                    if (row.remark == "1") {
                        return 'background: #a333c8;color:white'
                    }
                }
            });*/

            display();

            load();
            $("#dg").datagrid({
                url: '/admin/saleList/showTuZhiOpen',
                columns: [[
                    {
                        field: "saleNumber",
                        width: "150",
                        align: "center",
                        title: "订单编号"
                    },  {
                        field: "xiangmuId",
                        width: "150",
                        align: "center",
                        title: "项目号"
                    },  {
                        field: "shenqingNumber",
                        width: "150",
                        align: "center",
                        title: "申请单号"
                    }, {
                        field: 'wuliaoId',
                        title: '物料编号',
                        width: 100,
                        align: 'center',
                        formatter:function (val, row) {
                            if(row.count > 1){
                                var str = '<a href="javascript:chakan()" id="chakan" name="chakan" class="easyui-linkbutton"><span style="color: white;background: red">'+val+'</span></a>';
                                return str;
                            }else {
                                return val;
                            }

                        }
                    }, {
                        field: "tuzhiName",
                        width: "150",
                        align: "center",
                        title: "图纸名称"
                    }, {
                        field: "tuzhiId",
                        width: "150",
                        align: "center",
                        title: "图纸编号"
                    }, {
                        field: "num",
                        width: "150",
                        align: "center",
                        title: "数量",
                        formatter:function (val, row) {
                            if(row.count > 1){
                                var str = '<a href="javascript:chakan()" id="chakan" name="chakan" class="easyui-linkbutton"><span style="color: white;background: red">'+ '总数量：' +val+'</span></a>';
                                return str;
                            }else {
                                return val;
                            }

                        }

                    }, {
                        field: "saleDate",
                        width: "150",
                        align: "center",
                        title: "接单日期",
                        formatter: function (value, row, index) {
                            if (value) {
                                var date = new Date(value);
                                var o = {
                                    "M+": date.getMonth() + 1,                 //月份
                                    "d+": date.getDate(),                    //日
                                    "h+": date.getHours(),                   //小时
                                    "m+": date.getMinutes(),                 //分
                                    "s+": date.getSeconds(),                 //秒
                                    "q+": Math.floor((date.getMonth() + 3) / 3), //季度
                                    "S": date.getMilliseconds()             //毫秒
                                };
                                if (/(y+)/.test("yyyy-MM-dd hh:mm:ss"))
                                    var fmt = "yyyy-MM-dd hh:mm:ss".replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
                                for (var k in o)
                                    if (new RegExp("(" + k + ")").test(fmt))
                                        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                                return fmt;
                            } else {
                                return "";
                            }
                        },
                        sortable: true,
                        sorter: function(a, b) {
                            return (a > b ? 1 : -1);
                        }
                    }, {
                        field: "referDate",
                        width: "150",
                        align: "center",
                        title: "交货日期",
                        formatter: function (value, row, index) {
                            if (value) {
                                var date = new Date(value);
                                var o = {
                                    "M+": date.getMonth() + 1,                 //月份
                                    "d+": date.getDate(),                    //日
                                    "h+": date.getHours(),                   //小时
                                    "m+": date.getMinutes(),                 //分
                                    "s+": date.getSeconds(),                 //秒
                                    "q+": Math.floor((date.getMonth() + 3) / 3), //季度
                                    "S": date.getMilliseconds()             //毫秒
                                };
                                if (/(y+)/.test("yyyy-MM-dd hh:mm:ss"))
                                    var fmt = "yyyy-MM-dd hh:mm:ss".replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
                                for (var k in o)
                                    if (new RegExp("(" + k + ")").test(fmt))
                                        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                                return fmt;
                            } else {
                                return "";
                            }
                        },
                        sortable: true,
                        sorter: function(a, b) {
                            return (a > b ? 1 : -1);
                        }
                    }, {
                        field: "openState",
                        width: "150",
                        align: "center",
                        title: "展开状态"
                    }
                ]],remoteSort: false,
                onClickRow: function (index, row) {
                    $("#addSon").datagrid({
                        url: "/admin/saleList/bigSmallDrawing",
                        queryParams: {
                            wuliaoId: row.wuliaoId
                        },
                        columns: [[
                            {
                                field: 'id',
                                title: 'id',
                                width: 100,
                                hidden: 'true',
                                align: 'center'
                            }, {
                                field: 'wuliaoId',
                                title: '小图物料编号',
                                width: 100,
                                align: 'center',
                                formatter: function (row, value) {

                                    var wl = $("#wuliaoId").val();
                                    if (value.drawing != null || wl != null) {
                                        if (value.drawing) {
                                            return value.drawing.wuliaoId;
                                        } else if (wl != null) {
                                            return wl;
                                        } else {
                                            return "";
                                        }
                                    }

                                }
                            }, {
                                field: 'tuzhiName',
                                title: '图纸名称',
                                width: 100,
                                align: 'center',
                                formatter: function (row, value) {
                                    var tn = $("#tuZhiName").val();
                                    if (value.drawing != null || tn != null) {
                                        if (value.drawing) {
                                            return value.drawing.tuZhiName;
                                        } else if (tn != null) {
                                            return tn;
                                        } else {
                                            return "";
                                        }
                                    }
                                }
                            }, {
                                field: 'num',
                                title: '数量',
                                width: 100,
                                align: 'center'
                            }
                        ]]
                    });

                    $("#addSonRight").datagrid({
                        url: "/admin/wuliao/findByBigDrawingId",
                        queryParams: {
                            wuliaoId: row.wuliaoId
                        },
                        columns: [[
                            {
                                field: 'id',
                                title: 'id',
                                width: 100,
                                hidden: 'true',
                                align: 'center'
                            }, {
                                field: 'name',
                                title: '名称',
                                width: 100,
                                align: 'center'
                            }, {
                                field: 'guiGe',
                                title: '规格',
                                width: 100,
                                align: 'center'
                            }, {
                                field: 'num',
                                title: '数量',
                                width: 100,
                                align: 'center'
                            }, {
                                field: 'changJia',
                                title: '厂家',
                                width: 100,
                                align: 'center'
                            }, {
                                field: 'remark',
                                title: '备注',
                                width: 100,
                                align: 'center'
                            }
                        ]]
                    });
                }
            });
        });

        //若是group by的行点击显示所有行
        function chakan() {
            var row;
            if(Row == undefined){
                row = $("#dg").datagrid("getSelected");
            }else {
                row = Row;
            }
            $.post("/admin/saleList/tuzhiOpenChakan",{
                wuliaoId:row.wuliaoId
            },function (result) {
                if(result.success){
                    $("#dlg").dialog("open").dialog("setTitle","查看详细信息");
                    $("#dg2").datagrid("loadData",result.rows);
                }
            })

        }

        function loadDG2() {
            $("#dg2").datagrid({
                columns: [[
                    {
                        field: 'id',
                        title: 'id',
                        width: 100,
                        hidden: 'true',
                        align: 'center'
                    },{
                        field: 'saleNumber',
                        title: '订单编号',
                        width: 120,
                        align: 'center'
                    },{
                        field: 'xiangmuId',
                        title: '项目号',
                        width: 120,
                        align: 'center'
                    },{
                        field: 'wuliaoId',
                        title: '物料编号',
                        width: 130,
                        align: 'center'
                    },{
                        field: 'num',
                        title: '数量',
                        width: 50,
                        align: 'center'
                    }, {
                        field: "referDate",
                        width: "150",
                        align: "center",
                        title: "交货日期",
                        formatter: function (value, row, index) {
                            if (value) {
                                var date = new Date(value);
                                var o = {
                                    "M+": date.getMonth() + 1,                 //月份
                                    "d+": date.getDate(),                    //日
                                    "h+": date.getHours(),                   //小时
                                    "m+": date.getMinutes(),                 //分
                                    "s+": date.getSeconds(),                 //秒
                                    "q+": Math.floor((date.getMonth() + 3) / 3), //季度
                                    "S": date.getMilliseconds()             //毫秒
                                };
                                if (/(y+)/.test("yyyy-MM-dd hh:mm:ss"))
                                    var fmt = "yyyy-MM-dd hh:mm:ss".replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
                                for (var k in o)
                                    if (new RegExp("(" + k + ")").test(fmt))
                                        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                                return fmt;
                            } else {
                                return "";
                            }
                        }
                }]]
            })
        }

        //弹出的对话框中的值
        function load(){
            $("#son").datagrid({
                columns:[[
                    {
                        field: 'cb',
                        checkbox: "true",
                        align: "center"
                    },{
                        field:'id',
                        title:'id',
                        width:100,
                        hidden:'true',
                        align:'center'
                    },{
                        field:'drawingId',
                        title:'图纸编号',
                        width:100,
                        align:'center'
                    },{
                        field:'name',
                        title:'图纸名称',
                        width:100,
                        align:'center'
                    }
                ]]
            });

            //下方子图部分的列
            $("#addSon").datagrid({
                columns:[[
                    {
                        field:'id',
                        title:'id',
                        width:100,
                        hidden:'true',
                        align:'center'
                    },{
                        field:'wuliaoId',
                        title:'小图物料编号',
                        width:100,
                        align:'center'
                    },{
                        field:'tuzhiName',
                        title:'图纸名称',
                        width:100,
                        align:'center'
                    },{
                        field:'num',
                        title:'数量',
                        width:100,
                        align:'center'
                    }
                ]]
            });

            //右下物料明细列
            $("#addSonRight").datagrid({
                columns:[[
                    {
                        field:'id',
                        title:'id',
                        width:100,
                        hidden:'true',
                        align:'center'
                    },{
                        field:'name',
                        title:'名称',
                        width:100,
                        align:'center'
                    },{
                        field:'guiGe',
                        title:'规格',
                        width:100,
                        align:'center'
                    },{
                        field:'num',
                        title:'数量',
                        width:100,
                        align:'center'
                    },{
                        field:'changJia',
                        title:'厂家',
                        width:100,
                        align:'center'
                    },{
                        field:'remark',
                        title:'备注',
                        width:100,
                        align:'center'
                    }
                ]]
            });
        }

        //保存小图信息
        function OK() {
            if ( Row== null){
                $.messager.alert("系统提示","请选择大图纸");
                return;
            }
            if($("#addSon").datagrid("getRows").length == 0){
                //$.messager.alert("系统提示","请添加小图纸");
                return;
            }
            var wuliaoId = Row.wuliaoId;
            var smallDrawing = $("#addSon").datagrid("getRows");


            $.ajax({
                type:"post",
                url:"/admin/drawing/savaAboutWuliaoId",
                data:{
                    data: JSON.stringify(smallDrawing),
                },
                dataType:"json",
                success:function (result) {
                    if(result.success){
                        $.ajax({
                            type:"post",
                            url:"/admin/drawingType/addSonDrawing",
                            data:{
                                wuliaoId:wuliaoId,
                                data: JSON.stringify(smallDrawing)
                            },
                            dataType:"json",
                            success:function (result) {
                                if(result.success){
                                    $.messager.alert("系统提示","添加子图成功");
                                }
                            }
                        })
                    }
                }
            })
        }



        //刷新
        function reload() {
            $("#wuliaoSearch").val("");
            $("#xiangmuSearch").val("");
            $("#dg").datagrid("reload");
        }

        //删除选中的小图纸
        function shanchu() {
            var row = $("#addSon").datagrid("getSelected");
            console.log($("#addSon").datagrid("getRowIndex", row[0]));

            console.log(row);
            if(row == null){
                $.messager.alert("系统提示","请选择一条信息！");
                return;
            }

            if(row.id == undefined){
                $.messager.confirm("系统提示", "您确定要删除吗?", function (r) {
                    if (r) {
                        $("#addSon").datagrid("deleteRow",
                            $("#addSon").datagrid("getRowIndex",row));
                    }
                });
            }else {
                $.messager.confirm("系统提示", "您确定要删除吗?", function (r) {
                    if (r) {
                        $.post("/admin/drawingType/deleteById",{
                            id:row.id
                        },function (result) {
                            if(result.success){
                                $("#addSon").datagrid("reload");
                            }
                        },"json")
                    }
                });
            }
        }

        //导入小图信息
        function toLead() {
            if(Row == null){
                $.messager.alert("系统提示","请选择一条大图信息!")
                return;
            }
            $("#dlg3").dialog("open").dialog("setTitle", "选择上传文件");
        }

        //提交上传文件
        function saveToLead() {
            $("#fm3").form(
                'submit',
                {
                    url: "/admin/toLead/importFile",
                    onSubmit: function () { //onSubmit  事件会在表单中的确认按钮被点击时发生
                        var fileAccept = $("#fil").val().split(".")[1];
                        if (fileAccept != "xls" && fileAccept != "xlsx") {
                            alert("只能上传.xls和.xlsx的文件！");
                            return false;
                        }
                        return true;
                    },
                    success: function (result) {
                        var obj = eval('(' + result + ')');
                        if (obj.success) {

                        } else {
                            $.messager.alert("系统提示", "<span style='color:red'>"
                                + obj.errorInfo + "</span>");

                        }
                        var resultt = $.parseJSON(result);

                        console.log(resultt)

                        if(resultt.rows[0].name != null){
                           for(var i=0;i<resultt.rows.length;i++){
                                $("#addSonRight").datagrid("appendRow",{
                                    //wuliaoId:resultt.rows[i].wuliaoId
                                    name: resultt.rows[i].name,
                                    guiGe:resultt.rows[i].guiGe,
                                    num:resultt.rows[i].num,
                                    changJia:resultt.rows[i].changJia,
                                    remark:resultt.rows[i].remark
                                });
                           }
                        }else {
                           for(var i=0;i<resultt.rows.length;i++){
                               $("#addSon").datagrid("appendRow",{
                                   /*wuliaoId:resultt.rows[i].wuliaoId,
                                   tuzhiName:resultt.rows[i].tuzhiName,
                                   num:resultt.rows[i].num*/
                               });
                           }
                        }
                    }
                });
            closeToLead();
        }

        //关闭面导入面板
        function closeToLead() {
            $("#dlg3").dialog("close");
        }

        //手动添加子图
        function add(){
            if(!Row){
                $.messager.alert("系统提示","请选择一条大图信息!")
                return;
            }
            $("#addSonDrawing").dialog("open").dialog("setTitle", "添加图纸信息");
            $("#wuliaoId").val(Row.wuliaoId);
        }

        //添加小图物料
        function addWuLiaoId() {
            $("#addSon").datagrid("appendRow",{
                wuliaoId:$("#wuliaoId").val(),
                tuZhiName:$("#tuZhiName").val(),
                num:$("#num").val()
            });
            closeDialog()
        }

        function closeDialog() {
            $("#wuliaoId").val("");
            $("#tuZhiName").val("");
            $("#num").val("");
            $("#addSonDrawing").dialog("close");
        }


        //保存物料信息
        function saveWuliao() {
            if(Row==null){
                //$.messager.alert("系统提示","请选择大图信息！");
                return;
            }

            $.ajax({
                type:"post",
                url:"/admin/wuliao/save",
                data:{
                    data: JSON.stringify($("#addSonRight").datagrid("getRows")),
                    bigDrawing:Row.wuliaoId
                },
                dataType:"json",
                success:function (result) {
                    console.log("图纸图纸图纸图纸")
                    console.log(result)
                    console.log("图纸图纸图纸图纸")
                    if (result.success) {
                        $.post("/admin/yuanLiaoRequire/save",{
                            num:Row.num,
                            wuliaoId:Row.wuliaoId,
                            saleListId:Row.id
                        },function (result) {
                            if (result.success) {
                                $.messager.alert("系统提示", "保存成功！");
                            }
                            else {
                                $.messager.alert("系统提示", "保存失败！");
                                return;
                            }
                        },"json")
                    } else {
                        $.messager.alert("系统提示", "保存失败！");
                        return;
                    }
                }
            })
        }


        //手动添加物料
        function shoudongtianjia() {
            $("#dlg2").dialog("open").dialog("setTitle","手动添加物料明细");
        }

        //保存手动添加物料明细
        function save() {
            $('#addSonRight').datagrid('appendRow', {
                name: $("#name-add").val(),
                guiGe: $("#guiGe-add").val(),
                num: $("#num-add").val(),
                changJia: $("#changJia-add").val(),
                remark:$("#remark-add").val()
            });
            closeaddDialog();
        }

        //关闭手动添加物料明细对话框
        function closeaddDialog() {
            $("#name-add").val("");
            $("#guiGe-add").val("");
            $("#num-add").val("");
            $("#changJia-add").val("")
            $("#remark-add").val("")
            $("#dlg2").dialog("close");
        }

        //删除物料明细
        function deleteWuLiao() {
            var selectedRow = $("#addSonRight").datagrid("getSelected");
            if (selectedRow == null) {
                $.messager.alert("系统提示", "请选择一条要删除的商品！");
                return;
            }
            console.log(selectedRow);
            $.messager.confirm("系统提示", "您确定要删除这商品吗?", function (r) {
                if (r) {
                    if(selectedRow.id == undefined){
                        $("#addSonRight").datagrid("deleteRow",
                            $("#addSonRight").datagrid("getRowIndex", selectedRows[0]));
                    }else {
                        $.post("/admin/wuliao/deleteById",{
                            id:selectedRow.id
                        },function (result) {
                            if(result.success){
                                $("#addSonRight").datagrid("reload");
                            }
                        },"json")
                    }

                }
            });
        }

        //开始计时
        var Row;
        function start() {
            Row = $("#dg").datagrid("getSelected");

            if(Row == null){
                $.messager.alert("系统提示","请选择一条信息");
                return;
            }
            if(Row.openState == "" || Row.openState == null || Row.openState.substring(0,4) == "展开结束"){
                $.post("/admin/saleList/setOpenState",{
                    wuliaoId:Row.wuliaoId,
                    state:"展开中"
                },function (result) {
                    if(result.success){
                        if(result.error){
                            $.messager.alert("系统提示",result.error);
                            return;
                        }else {
                            $.post("/admin/bigdrawing/jiShi",{
                                code:1,
                                wuliaoId:Row.wuliaoId
                            },function (result) {
                                if(result.success){
                                    //$.messager.alert("系统提示","图纸展开开始");
                                    show();
                                    $('#dg').datagrid({
                                        rowStyler:function(index,row){
                                            if (index == $("#dg").datagrid("getRowIndex",$("#dg").datagrid("getSelected"))){
                                                return 'background-color:green;color:white;font-weight:bold;';
                                            }
                                        },
                                        onClickRow:function (index, data) {
                                            $("#dg").datagrid("unselectRow",index);
                                        }
                                    });
                                }
                            },"json")
                        }
                    }
                },"json");
            }else if(Row.openState != "展开中："+user){
                console.log(22)
                $.messager.alert("系统提示","该图纸"+Row.openState.substring(4)+"正在展开，请选择别的图纸展开！");
                display();
                return;
            }else if(Row.openState == "展开中："+user){
                console.log(33 )
                //$.messager.alert("系统提示","图纸展开开始");
                show();
                $('#dg').datagrid({
                    rowStyler:function(index,row){
                        if (index == $("#dg").datagrid("getRowIndex",$("#dg").datagrid("getSelected"))){
                            return 'background-color:green;color:white;font-weight:bold;';
                        }
                    },
                    onClickRow:function (index, data) {
                        $("#dg").datagrid("unselectRow",index);
                    }
                });
            }
        }

        //结束计时
        function stop() {
            display();
            OK();
            saveWuliao();

            $.post("/admin/saleList/setOpenState",{
                wuliaoId:Row.wuliaoId,
                state:"展开结束"
            },function (result) {
                if(result.success){
                    $.post("/admin/bigdrawing/jiShi",{
                        code:2,
                        wuliaoId:Row.wuliaoId,
                        user:user
                    },function (result) {
                        if(result.success){
                            //alert("图纸展开结束");
                            window.location.reload();
                        }else {
                            $.messager.alert("系统提示","操作失败");
                            return;
                        }
                    },"json")
                }
            },"json")
        }

        /**
         * 隐藏按钮
         */
        function display(){

            $("#start").linkbutton("enable");
            $("#finish").linkbutton("enable");

            $("#addWuliao").linkbutton("disable");
            $("#stop").linkbutton("disable");
            $("#add").linkbutton("disable");
            $("#toLead").linkbutton("disable");
            $("#OK").linkbutton("disable");
            $("#shanchu").linkbutton("disable");
            $("#xiugaiTuzhi").linkbutton("disable");
            $("#toleadWuLiao").linkbutton("disable");
            $("#shoudongtianjia").linkbutton("disable");
            $("#deleteWuLiao").linkbutton("disable");
            $("#saveWuLiao").linkbutton("disable");
        }

        /**toleadWuLiao  shoudongtianjia  deleteWuLiao
         * 显示按钮
         */
        function show() {
            $("#start").linkbutton("disable");
            $("#finish").linkbutton("disable");

            $("#addWuliao").linkbutton("enable");
            $("#stop").linkbutton("enable");
            $("#add").linkbutton("enable");
            $("#toLead").linkbutton("enable");
            $("#OK").linkbutton("enable");
            $("#shanchu").linkbutton("enable");
            $("#xiugaiTuzhi").linkbutton("enable");
            $("#toleadWuLiao").linkbutton("enable");
            $("#shoudongtianjia").linkbutton("enable");
            $("#deleteWuLiao").linkbutton("enable");
            $("#saveWuLiao").linkbutton("enable");
        }

        //图纸展开完成
        function finish() {
            var row = $("#dg").datagrid("getSelected");
            var rows = $("#addSon").datagrid("getRows");
            var rowRight = $("#addSonRight").datagrid("getRows");

            if(row == null){
                $.messager.alert("系统提示","请选择一条信息！");
                return;
            }

            if(row.openState != null && row.openState.substring(0,3) == "展开中"){
                $.messager.alert("系统提示","您有图纸正在展开！");
                return;
            }
            if(row.openState == null){
                return;
            }

            if(row.openState.substring(0,4) != "展开结束"){
                return;
            }

            if(rows.length == 0 || rowRight.length == 0){
                $.messager.confirm("系统提示","<span style='color:red'>"+"信息未添加完整，是否继续添加？"+"</span>", function(r){
                    if (r){
                        return;
                    }else {
                        console.log(3)
                        $.post("/admin/saleList/finishOpen",{
                            id:row.id,
                            wuliaoId:row.wuliaoId
                        },function (result) {
                            if(result.success){
                                //alert("保存成功！");
                                window.location.reload();
                            }
                            else {
                                alert(result.errorInfo);
                            }
                        });
                    }
                });
            }else {
                $.post("/admin/saleList/finishOpen",{
                    id:row.id,
                    wuliaoId:row.wuliaoId
                },function (result) {
                    if(result.success){
                        //alert("保存成功！");
                        window.location.reload();
                    }
                    else {
                        alert(result.errorInfo);
                    }
                });
            }
        }

        //修改添加的小图纸的信息
        function xiugaiTuzhi() {
            var row = $("#addSon").datagrid("getSelected");
            console.log(row)
            if(row == null){
                $.messager.alert("系统提示","请选择一条要修改的信息！");
                return;
            }
            $("#dlg-xiugaiTuzhi").dialog("open").dialog("setTitle","修改信息");
            if(row.id == undefined){
                $("#wuliaoId-xiugai").val(row.wuliaoId);
                $("#tuZhiName-xiugai").val(row.tuZhiName);
                $("#num-xiugai").val(row.num);
            }else {
                $("#wuliaoId-xiugai").val(row.drawing.wuliaoId);
                $("#tuZhiName-xiugai").val(row.drawing.tuZhiName);
                $("#num-xiugai").val(row.num);
            }
        }

        //修改添加的物料的信息
        function xiugaiWuliao() {
            var row = $("#addSonRight").datagrid("getSelected");
            if(row == null){
                $.messager.alert("系统提示","请选择一条要修改的信息！");
                return;
            }
            $("#dlg-xiugaiWuliao").dialog("open").dialog("setTitle","修改信息");
            $("#name-xiugai").val(row.name);
            $("#guiGe-xiugai").val(row.guiGe);
            $("#wuliaonum-xiugai").val(row.num);
            $("#changJia-xiugai").val(row.changJia);
            $("#remark-xiugai").val(row.remark);
        }

        //保存修改小图
        function saveXiuGaiXiaotu() {
            var row = $("#addSon").datagrid("getSelected");
            if(row.id == undefined){
                $("#wuliaoId").val($("#wuliaoId-xiugai").val());
                $("#tuZhiName").val($("#tuZhiName-xiugai").val());
                $("#num").val($("#num-xiugai").val());
                $("#addSon").datagrid("updateRow",{
                    index: $("#addSon").datagrid("getRowIndex",row),
                    row:{
                        wuliaoId:$("#wuliaoId").val(),
                        tuZhiName:$("#tuZhiName").val(),
                        num:$("#num").val()
                    }
                })
                closeXiuGaiXiaotu();
            }else {
                $.post("/admin/drawingType/xiugai",{
                    id:row.id,
                    wuliaoId:$("#wuliaoId-xiugai").val(),
                    num:$("#num-xiugai").val(),
                    tuZhiName:$("#tuZhiName-xiugai").val()
                },function (result) {
                    if(result.success){
                        $.messager.alert("系统提示","修改成功");
                        closeXiuGaiXiaotu();
                        $("#addSon").datagrid("reload");
                    }
                })
            }
        }

        //关闭修改小图对话框
        function closeXiuGaiXiaotu() {
            $("#dlg-xiugaiTuzhi").dialog("close");
            $("#wuliaoId-xiugai").val("");
            $("#tuZhiName-xiugai").val("");
            $("#num-xiugai").val("");
        }

        //保存修改物料
        function saveXiuGaiWuliao() {

        }

        //关闭修改物料对话框
        function closeXiuGaiWuliao() {

        }


    </script>
</head>    <!--上面的dg  下面的addSon-->
<body class="easyui-layout" style="margin: 1px">
<div region="north" split="true" style="height: 450px">
    <table id="dg" class="easyui-datagrid"
           fitColumns="false" rownumbers="true" singleSelect="true" fit="true"
           toolbar="#tb1" split="true">
    </table>

    <!-- dg顶部工具栏 -->
    <div id="tb1">
        <fieldset style="border-color: #E7F0FF">
            <legend>查询设置</legend>
            <form id="search">
            &nbsp;物料编号：<input type="text" id="wuliaoSearch" name="wuliaoId" autocomplete="off"
                   size="15" onkeydown="if(event.keyCode==13) searchSale()" />
                &nbsp;&nbsp;&nbsp;申请单号：<input type="text" id="xiangmuSearch" name="xiangmuId" autocomplete="off"
                   size="15" onkeydown="if(event.keyCode==13) searchSale()" />

            &nbsp;&nbsp;<a href="javascript:searchSale()"
                           class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>
            &nbsp;&nbsp;<a href="javascript:reload()"
                                 class="easyui-linkbutton" iconCls="icon-reload" plain="true">刷新</a>
            &nbsp;&nbsp;<a href="javascript:start()" id="start"
                                             class="easyui-linkbutton" iconCls="icon-add" plain="true">开始展开</a>
            &nbsp;&nbsp;<a href="javascript:stop()" id="stop"
                                             class="easyui-linkbutton" iconCls="icon-add" plain="true">展开结束</a>
            &nbsp;&nbsp;<a href="javascript:finish()" id="finish"
                                             class="easyui-linkbutton" iconCls="icon-ok" plain="true">展开完成</a>
            </form>
        </fieldset>
    </div>
</div>

<!--左下方小图框-->
<div region="center" style="margin-top: 5px;width:500px" >
    <table id="addSon" class="easyui-datagrid" fitColumns="false" singleSelect="true"
           rownumbers="true" fit="true" split="true" toolbar="#tb2">
    </table>
</div>

<div id="tb2">
    <div>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:add()" id="add"
                                         class="easyui-linkbutton" iconCls="icon-add" plain="true">手动添加子图</a>
        <!--&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:toLead()" id="toLead"
                                         class="easyui-linkbutton" iconCls="icon-add" plain="true">EXCEL导入子图</a>-->
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:xiugaiTuzhi()" id="xiugaiTuzhi"
                                         class="easyui-linkbutton" iconCls="icon-reload" plain="true">修改</a>
        <!--&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:OK()" id="OK"
                                         class="easyui-linkbutton" iconCls="icon-save" plain="true">保存</a>-->
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:shanchu()" id="shanchu"
                                         class="easyui-linkbutton" iconCls="icon-remove" plain="true">删除</a>
    </div>
</div>

<!--右下方物料明细框-->
<div region="east" style="margin-top: 5px;width:630px" >
    <table id="addSonRight" class="easyui-datagrid" fitColumns="false" singleSelect="true"
           rownumbers="true" fit="true" split="true" toolbar = "#tb3" >
    </table>
</div>

<div id="tb3">
    <div>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:toLead()" class="easyui-linkbutton" id="toleadWuLiao"
           iconCls="icon-add" plain="true">导入</a>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:shoudongtianjia()" id="shoudongtianjia"
           class="easyui-linkbutton" iconCls="icon-add" plain="true">手动添加</a>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:deleteWuLiao()" class="easyui-linkbutton" id="deleteWuLiao"
           iconCls="icon-remove" plain="true">删除</a>
      <!--  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:xiugaiWuliao()" class="easyui-linkbutton" id="xiugaiWuliao"
           iconCls="icon-reload"plain="true">修改</a>-->
        <!--&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:saveWuliao()" class="easyui-linkbutton" id="saveWuLiao"
           iconCls="icon-ok"plain="true">保存</a>-->
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:red'>注意：此处添加的物料数量为一套的数量！</span>
    </div>
</div>



<!--弹出来添加子图的对话框-->
<div class="easyui-dialog" id="addSonDrawing" style="width: 350px; height: 200px; padding: 10px 20px"
     closed="true" buttons="#addSonDrawing-buttons">
    <form id="fm" method="post" enctype="multipart/form-data">
        <table cellspacing="8px">
            <tr>
                <td>物料编号：</td>
                <td><input type="text" id="wuliaoId" name="wuliaoId"
                           class="easyui-validatebox" required="true" /></td>
            </tr>
            <tr>
                <td>图纸名称：</td>
                <td><input type="text" id="tuZhiName" name="tuZhiName"
                           class="easyui-validatebox" required="true" /></td>
            </tr>
            <tr>
                <td>数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;量：</td>
                <td><input type="text" id="num" name="num" onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}" onafterpaste="if(this.value.length==1)
                    {this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"/></td>
            </tr>
        </table>
    </form>
</div>
<div id="addSonDrawing-buttons">
    <a href="javascript:addWuLiaoId()" class="easyui-linkbutton"
       iconCls="icon-ok">添加</a> <a href="javascript:closeDialog()"
                                   class="easyui-linkbutton" iconCls="icon-cancel">关闭</a>
</div>
<!--打开导入面板-->
<div id="dlg3" class="easyui-dialog"
     style="width: 400px; height: 180px; padding: 10px 20px" closed="true"
     buttons="#dlg-buttons2"
     data-options="">
    <form id="fm3" method="post" enctype="multipart/form-data"
          action="/admin/toLead/importFile">
        <input id="fil" name="fileName" type="file"/>
    </form>
</div>
<!--导入文件-->
<div id="dlg-buttons2">
    <a href="javascript:saveToLead()" class="easyui-linkbutton"
       iconCls="icon-ok">确定</a> <a href="javascript:closeToLead()"
                                   class="easyui-linkbutton" iconCls="icon-cancel">关闭</a>
</div>

<!--手动添加物料信息-->
<div id="dlg2" class="easyui-dialog"
     style="width: 400px; height: 180px; padding: 10px 20px" closed="true"
     buttons="#dlg2-buttons">
    <form id="fm-add" method="post">
        <table>
            <tr>

                <td>名称：</td>
                <td><input type="text" id="name-add" name="name"
                           class="easyui-validatebox" style="width: 120px"/></td>
                <td>&nbsp;</td>
                <td>规格：</td>
                <td><input type="text" id="guiGe-add" name="guiGe"
                           class="easyui-validatebox" style="width: 120px"/></td>
            </tr>
            <tr>
                <td>数量：</td>
                <td><input type="text" id="num-add" name="num"
                           class="easyui-validatebox" style="width: 120px"/></td>
                <td>&nbsp;</td>
                <td>厂家：</td>
                <td><input type="text" id="changJia-add" name="changJia"
                           class="easyui-validatebox" style="width: 120px"/></td>
            </tr>
            <tr>
                <td>备注：</td>
                <td><input type="text" id="remark-add" name="num"
                           class="easyui-validatebox" style="width: 120px"/></td>
                <td>&nbsp;</td>
            </tr>
        </table>
    </form>
</div>
<div id="dlg2-buttons">
    <a href="javascript:save()" class="easyui-linkbutton"
       iconCls="icon-ok">保存</a>
    <a href="javascript:closeaddDialog()"
       class="easyui-linkbutton" iconCls="icon-cancel">关闭</a>
</div>

<!--修改小图信息对话框-->
<div id="dlg-xiugaiTuzhi" class="easyui-dialog" style="width: 300px;height: 150px;"
     closed="true" buttons="#dlg-buttons">
        <table cellspacing="8px">
            <tr>
                <td>小图纸物料编号：</td>
                <td><input type="text" id="wuliaoId-xiugai" name="wuliaoId" required="true"/></td>
            </tr>
            <tr>
                <td>图纸名称：</td>
                <td><input type="text" id="tuZhiName-xiugai" name="tuZhiName" required="true"/></td>
            </tr>
            <tr>
                <td>数量：</td>
                <td><input type="text" id="num-xiugai" name="num" required="true"/></td>
            </tr>
        </table>
    </form>
</div>
<!-- 对话框按钮 -->
<div id="dlg-buttons">
    <a href="javascript:saveXiuGaiXiaotu()" class="easyui-linkbutton" iconCls="icon-ok" >保存</a>
    <a href="javascript:closeXiuGaiXiaotu()" class="easyui-linkbutton" iconCls="icon-cancel" >关闭</a>
</div>


<!--修改物料信息对话框-->
<div id="dlg-xiugaiWuliao" class="easyui-dialog" style="width: 300px;height: 150px;"
     closed="true" buttons="#dlg-buttons1">
        <table cellspacing="8px">
            <tr>
                <td>名称：</td>
                <td><input type="text" id="name-xiugai" name="name" required="true"/></td>
            </tr>
            <tr>
                <td>规格：</td>
                <td><input type="text" id="guiGe-xiugai" name="guiGe" required="true"/></td>
            </tr>
            <tr>
                <td>数量：</td>
                <td><input type="text" id="wuliaonum-xiugai" name="num" required="true"/></td>
            </tr>
            <tr>
                <td>厂家：</td>
                <td><input type="text" id="changJia-xiugai" name="changJia" required="true"/></td>
            </tr>
            <tr>
                <td>备注：</td>
                <td><input type="text" id="remark-xiugai" name="remark" required="true"/></td>
            </tr>
        </table>
    </form>
</div>
<!-- 对话框按钮 -->
<div id="dlg-buttons1">
    <a href="javascript:saveXiuGaiWuliao()" class="easyui-linkbutton" iconCls="icon-ok" >保存</a>
    <a href="javascript:closeXiuGaiWuliao()" class="easyui-linkbutton" iconCls="icon-cancel" >关闭</a>
</div>

<!--显示与该物料号相关的所有的订单信息-->
<div id="dlg" class="easyui-dialog"
     style="width: 690px; height: 280px; padding: 10px 20px" closed="true">
    <table id="dg2" class="easyui-datagrid"
           rownumbers="true" singleSelect="true" fit="true">
    </table>
</div>
</body>
</html>